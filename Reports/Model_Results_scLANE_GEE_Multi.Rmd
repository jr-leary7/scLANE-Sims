---
title: "Simulation Study - Process `scLANE (GEE)` Multi-subject Models"
subtitle: "UF Dept. of Biostatistics - Bacher Group"
author: "Jack Leary" 
date: "`r Sys.Date()`"
output:
  html_document:
    theme: journal
    highlight: tango
    code_folding: show
    code_download: true 
    toc: true 
    toc_depth: 2
    toc_float: true
    df_print: kable
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE); set.seed(312)  # lucky seed
```

# Libraries 

First we'll load in the packages we need to tidy & analyze our simulation results. 

```{r, results='hide', message=FALSE, warning=FALSE}
library(dplyr)      # data manipulation 
library(ggplot2)    # plots
library(targets)    # pipeline tools
library(paletteer)  # plot colors 
library(patchwork)  # plot combination
```

# Color Palette

We'll be doing some complex visualization, so we'll pick out a good color palette beforehand to make our code more readable & ensure that we don't run in to errors caused by the palette not being long enough. 

```{r, message=FALSE, warning=FALSE}
model_palette <- paletteer_d("ggsci::category20_d3")
```

# Data 

Now we'll load in the model results generated by running `scLANE` with the GEE backend on the multi-subject simulated datasets. Splitting by the reference dataset used, we'll load the objects & then iterate over them, pulling out the necessary metrics from each one. 

## Brain 

First the simulations from the brain reference. 

```{r}
# 100 cells 
tar_load(scLANE_GEE_brain_DEG_10_CELLS_100_balanced, store = "../store_scLANE_GEE_multi/")
tar_load(scLANE_GEE_brain_DEG_20_CELLS_100_balanced, store = "../store_scLANE_GEE_multi/")
tar_load(scLANE_GEE_brain_DEG_10_CELLS_100_unbalanced, store = "../store_scLANE_GEE_multi/")
tar_load(scLANE_GEE_brain_DEG_20_CELLS_100_unbalanced, store = "../store_scLANE_GEE_multi/")
# 500 cells 
tar_load(scLANE_GEE_brain_DEG_10_CELLS_500_balanced, store = "../store_scLANE_GEE_multi/")
tar_load(scLANE_GEE_brain_DEG_20_CELLS_500_balanced, store = "../store_scLANE_GEE_multi/")
tar_load(scLANE_GEE_brain_DEG_10_CELLS_500_unbalanced, store = "../store_scLANE_GEE_multi/")
tar_load(scLANE_GEE_brain_DEG_20_CELLS_500_unbalanced, store = "../store_scLANE_GEE_multi/")
# 1000 cells 
tar_load(scLANE_GEE_brain_DEG_10_CELLS_1000_balanced, store = "../store_scLANE_GEE_multi/")
tar_load(scLANE_GEE_brain_DEG_20_CELLS_1000_balanced, store = "../store_scLANE_GEE_multi/")
tar_load(scLANE_GEE_brain_DEG_10_CELLS_1000_unbalanced, store = "../store_scLANE_GEE_multi/")
tar_load(scLANE_GEE_brain_DEG_20_CELLS_1000_unbalanced, store = "../store_scLANE_GEE_multi/")
# 2500 cells 
tar_load(scLANE_GEE_brain_DEG_10_CELLS_2500_balanced, store = "../store_scLANE_GEE_multi/")
tar_load(scLANE_GEE_brain_DEG_20_CELLS_2500_balanced, store = "../store_scLANE_GEE_multi/")
tar_load(scLANE_GEE_brain_DEG_10_CELLS_2500_unbalanced, store = "../store_scLANE_GEE_multi/")
tar_load(scLANE_GEE_brain_DEG_20_CELLS_2500_unbalanced, store = "../store_scLANE_GEE_multi/")
# 5000 cells 
tar_load(scLANE_GEE_brain_DEG_10_CELLS_5000_balanced, store = "../store_scLANE_GEE_multi/")
tar_load(scLANE_GEE_brain_DEG_20_CELLS_5000_balanced, store = "../store_scLANE_GEE_multi/")
tar_load(scLANE_GEE_brain_DEG_10_CELLS_5000_unbalanced, store = "../store_scLANE_GEE_multi/")
tar_load(scLANE_GEE_brain_DEG_20_CELLS_5000_unbalanced, store = "../store_scLANE_GEE_multi/")
```

We coerce the model results to a table.  

```{r}
scLANE_brain_metrics <- purrr::map(ls(pattern = "scLANE_GEE_brain*"), function(u) {
  obj <- eval(as.symbol(u))
  perf <- tibble(DATASET_NAME = u, 
                 MODEL_TYPE = "scLANE", 
                 PERCENT_DEG = paste0(obj$sim_parameters[[1]]$Prop_Dyn_Gene * 100, "%"), 
                 N_CELLS = obj$sim_parameters[[1]]$Cells, 
                 N_GENES = length(obj$testDynamic_results_raw[[1]]), 
                 N_PRED_DYNAMIC_GENES = sum(obj$testDynamic_results_tidy[[1]]$Gene_Dynamic_Overall), 
                 N_TRUE_DYNAMIC_GENES = sum(obj$testDynamic_results_tidy[[1]]$geneStatus_overall == "Dynamic"), 
                 RUNTIME = as.numeric(obj$time_diff[[1]]), 
                 RUNTIME_UNITS = attributes(obj$time_diff[[1]])$units, 
                 MEM_USED = obj$mem_usage[[1]][1] / 1000^2,
                 MEM_UNITS = "MB", 
                 ROC_AUC = yardstick::roc_auc_vec(truth = factor(obj$testDynamic_results_tidy[[1]]$geneStatus_overall, levels = c("Dynamic", "NotDynamic")), 
                                                  estimate = obj$testDynamic_results_tidy[[1]]$P_Val, 
                                                  event_level = "second"), 
                 ACCURACY = yardstick::accuracy_vec(truth = factor(obj$testDynamic_results_tidy[[1]]$geneStatus_overall, levels = c("Dynamic", "NotDynamic")), 
                                                    estimate = factor(ifelse(obj$testDynamic_results_tidy[[1]]$Gene_Dynamic_Overall == 1, "Dynamic", "NotDynamic"), 
                                                                      levels = c("Dynamic", "NotDynamic"))), 
                 SENSITIVITY = yardstick::sens_vec(truth = factor(obj$testDynamic_results_tidy[[1]]$geneStatus_overall, levels = c("Dynamic", "NotDynamic")), 
                                                   estimate = factor(ifelse(obj$testDynamic_results_tidy[[1]]$Gene_Dynamic_Overall == 1, "Dynamic", "NotDynamic"), 
                                                                     levels = c("Dynamic", "NotDynamic"))), 
                 SPECIFICITY = yardstick::spec_vec(truth = factor(obj$testDynamic_results_tidy[[1]]$geneStatus_overall, levels = c("Dynamic", "NotDynamic")), 
                                                   estimate = factor(ifelse(obj$testDynamic_results_tidy[[1]]$Gene_Dynamic_Overall == 1, "Dynamic", "NotDynamic"), 
                                                                     levels = c("Dynamic", "NotDynamic"))), 
                 RECALL = yardstick::recall_vec(truth = factor(obj$testDynamic_results_tidy[[1]]$geneStatus_overall, levels = c("Dynamic", "NotDynamic")), 
                                                estimate = factor(ifelse(obj$testDynamic_results_tidy[[1]]$Gene_Dynamic_Overall == 1, "Dynamic", "NotDynamic"), 
                                                                  levels = c("Dynamic", "NotDynamic"))), 
                 PRECISION = yardstick::precision_vec(truth = factor(obj$testDynamic_results_tidy[[1]]$geneStatus_overall, levels = c("Dynamic", "NotDynamic")), 
                                                      estimate = factor(ifelse(obj$testDynamic_results_tidy[[1]]$Gene_Dynamic_Overall == 1, "Dynamic", "NotDynamic"), 
                                                                        levels = c("Dynamic", "NotDynamic"))),
                 AUC_PR = yardstick::pr_auc_vec(truth = factor(obj$testDynamic_results_tidy[[1]]$geneStatus_overall, levels = c("Dynamic", "NotDynamic")), 
                                                estimate = obj$testDynamic_results_tidy[[1]]$P_Val, 
                                                event_level = "second"),
                 F_MEASURE = yardstick::f_meas_vec(truth = factor(obj$testDynamic_results_tidy[[1]]$geneStatus_overall, levels = c("Dynamic", "NotDynamic")), 
                                                   estimate = factor(ifelse(obj$testDynamic_results_tidy[[1]]$Gene_Dynamic_Overall == 1, "Dynamic", "NotDynamic"), 
                                                                           levels = c("Dynamic", "NotDynamic"))),
                 BAL_ACCURACY = yardstick::bal_accuracy_vec(truth = factor(obj$testDynamic_results_tidy[[1]]$geneStatus_overall, levels = c("Dynamic", "NotDynamic")), 
                                                            estimate = factor(ifelse(obj$testDynamic_results_tidy[[1]]$Gene_Dynamic_Overall == 1, "Dynamic", "NotDynamic"), 
                                                                                    levels = c("Dynamic", "NotDynamic"))), 
                 NIR = mean(obj$testDynamic_results_tidy[[1]]$geneStatus_overall == "NotDynamic"), 
                 ROC_CURVE = list(yardstick::roc_curve(obj$testDynamic_results_tidy[[1]], 
                                                       truth = factor(geneStatus_overall, levels = c("Dynamic", "NotDynamic")), 
                                                       .estimate = P_Val, 
                                                       event_level = "second") %>% 
                                  mutate(dataset = u)), 
                 PR_CURVE = list(yardstick::pr_curve(obj$testDynamic_results_tidy[[1]], 
                                                     truth = factor(geneStatus_overall, levels = c("Dynamic", "NotDynamic")), 
                                                     .estimate = P_Val, 
                                                     event_level = "second") %>% 
                                 mutate(dataset = u)))
  rm(obj)
  return(perf)
}) %>% 
  purrr::reduce(rbind) %>% 
  mutate(RUNTIME_HOURS = case_when(RUNTIME_UNITS == "secs" ~ RUNTIME / 60^2, 
                                   RUNTIME_UNITS == "mins" ~ RUNTIME / 60, 
                                   RUNTIME_UNITS == "hours" ~ RUNTIME, 
                                   RUNTIME_UNITS == "days" ~ RUNTIME * 24, 
                                   TRUE ~ NA_real_), 
         .before = 10)
```

```{r, echo=FALSE, warning=FALSE, results='hide'}
rm(list = ls(pattern = "scLANE_GEE_brain*")); gc(full = TRUE)
```

## Pancreas 

Next the results from the pancreas reference. 

```{r}
# 100 cells 
tar_load(scLANE_GEE_panc_DEG_10_CELLS_100_balanced, store = "../store_scLANE_GEE_multi/")
tar_load(scLANE_GEE_panc_DEG_20_CELLS_100_balanced, store = "../store_scLANE_GEE_multi/")
tar_load(scLANE_GEE_panc_DEG_10_CELLS_100_unbalanced, store = "../store_scLANE_GEE_multi/")
tar_load(scLANE_GEE_panc_DEG_20_CELLS_100_unbalanced, store = "../store_scLANE_GEE_multi/")
# 500 cells 
tar_load(scLANE_GEE_panc_DEG_10_CELLS_500_balanced, store = "../store_scLANE_GEE_multi/")
tar_load(scLANE_GEE_panc_DEG_20_CELLS_500_balanced, store = "../store_scLANE_GEE_multi/")
tar_load(scLANE_GEE_panc_DEG_10_CELLS_500_unbalanced, store = "../store_scLANE_GEE_multi/")
tar_load(scLANE_GEE_panc_DEG_20_CELLS_500_unbalanced, store = "../store_scLANE_GEE_multi/")
# 1000 cells 
tar_load(scLANE_GEE_panc_DEG_10_CELLS_1000_balanced, store = "../store_scLANE_GEE_multi/")
tar_load(scLANE_GEE_panc_DEG_20_CELLS_1000_balanced, store = "../store_scLANE_GEE_multi/")
tar_load(scLANE_GEE_panc_DEG_10_CELLS_1000_unbalanced, store = "../store_scLANE_GEE_multi/")
tar_load(scLANE_GEE_panc_DEG_20_CELLS_1000_unbalanced, store = "../store_scLANE_GEE_multi/")
# 2500 cells 
tar_load(scLANE_GEE_panc_DEG_10_CELLS_2500_balanced, store = "../store_scLANE_GEE_multi/")
tar_load(scLANE_GEE_panc_DEG_20_CELLS_2500_balanced, store = "../store_scLANE_GEE_multi/")
tar_load(scLANE_GEE_panc_DEG_10_CELLS_2500_unbalanced, store = "../store_scLANE_GEE_multi/")
tar_load(scLANE_GEE_panc_DEG_20_CELLS_2500_unbalanced, store = "../store_scLANE_GEE_multi/")
# 5000 cells 
tar_load(scLANE_GEE_panc_DEG_10_CELLS_5000_balanced, store = "../store_scLANE_GEE_multi/")
tar_load(scLANE_GEE_panc_DEG_20_CELLS_5000_balanced, store = "../store_scLANE_GEE_multi/")
tar_load(scLANE_GEE_panc_DEG_10_CELLS_5000_unbalanced, store = "../store_scLANE_GEE_multi/")
tar_load(scLANE_GEE_panc_DEG_20_CELLS_5000_unbalanced, store = "../store_scLANE_GEE_multi/")
```

Again we format the model results in a table. 

```{r}
scLANE_panc_metrics <- purrr::map(ls(pattern = "scLANE_GEE_panc*"), function(u) {
  obj <- eval(as.symbol(u))
  perf <- tibble(DATASET_NAME = u, 
                 MODEL_TYPE = "scLANE", 
                 PERCENT_DEG = paste0(obj$sim_parameters[[1]]$Prop_Dyn_Gene * 100, "%"), 
                 N_CELLS = obj$sim_parameters[[1]]$Cells, 
                 N_GENES = length(obj$testDynamic_results_raw[[1]]), 
                 N_PRED_DYNAMIC_GENES = sum(obj$testDynamic_results_tidy[[1]]$Gene_Dynamic_Overall), 
                 N_TRUE_DYNAMIC_GENES = sum(obj$testDynamic_results_tidy[[1]]$geneStatus_overall == "Dynamic"), 
                 RUNTIME = as.numeric(obj$time_diff[[1]]), 
                 RUNTIME_UNITS = attributes(obj$time_diff[[1]])$units, 
                 MEM_USED = obj$mem_usage[[1]][1] / 1000^2,
                 MEM_UNITS = "MB", 
                 ROC_AUC = yardstick::roc_auc_vec(truth = factor(obj$testDynamic_results_tidy[[1]]$geneStatus_overall, levels = c("Dynamic", "NotDynamic")), 
                                                  estimate = obj$testDynamic_results_tidy[[1]]$P_Val, 
                                                  event_level = "second"), 
                 ACCURACY = yardstick::accuracy_vec(truth = factor(obj$testDynamic_results_tidy[[1]]$geneStatus_overall, levels = c("Dynamic", "NotDynamic")), 
                                                    estimate = factor(ifelse(obj$testDynamic_results_tidy[[1]]$Gene_Dynamic_Overall == 1, "Dynamic", "NotDynamic"), 
                                                                      levels = c("Dynamic", "NotDynamic"))), 
                 SENSITIVITY = yardstick::sens_vec(truth = factor(obj$testDynamic_results_tidy[[1]]$geneStatus_overall, levels = c("Dynamic", "NotDynamic")), 
                                                   estimate = factor(ifelse(obj$testDynamic_results_tidy[[1]]$Gene_Dynamic_Overall == 1, "Dynamic", "NotDynamic"), 
                                                                     levels = c("Dynamic", "NotDynamic"))), 
                 SPECIFICITY = yardstick::spec_vec(truth = factor(obj$testDynamic_results_tidy[[1]]$geneStatus_overall, levels = c("Dynamic", "NotDynamic")), 
                                                   estimate = factor(ifelse(obj$testDynamic_results_tidy[[1]]$Gene_Dynamic_Overall == 1, "Dynamic", "NotDynamic"), 
                                                                     levels = c("Dynamic", "NotDynamic"))), 
                 RECALL = yardstick::recall_vec(truth = factor(obj$testDynamic_results_tidy[[1]]$geneStatus_overall, levels = c("Dynamic", "NotDynamic")), 
                                                estimate = factor(ifelse(obj$testDynamic_results_tidy[[1]]$Gene_Dynamic_Overall == 1, "Dynamic", "NotDynamic"), 
                                                                  levels = c("Dynamic", "NotDynamic"))), 
                 PRECISION = yardstick::precision_vec(truth = factor(obj$testDynamic_results_tidy[[1]]$geneStatus_overall, levels = c("Dynamic", "NotDynamic")), 
                                                      estimate = factor(ifelse(obj$testDynamic_results_tidy[[1]]$Gene_Dynamic_Overall == 1, "Dynamic", "NotDynamic"), 
                                                                        levels = c("Dynamic", "NotDynamic"))),
                 AUC_PR = yardstick::pr_auc_vec(truth = factor(obj$testDynamic_results_tidy[[1]]$geneStatus_overall, levels = c("Dynamic", "NotDynamic")), 
                                                estimate = obj$testDynamic_results_tidy[[1]]$P_Val, 
                                                event_level = "second"),
                 F_MEASURE = yardstick::f_meas_vec(truth = factor(obj$testDynamic_results_tidy[[1]]$geneStatus_overall, levels = c("Dynamic", "NotDynamic")), 
                                                   estimate = factor(ifelse(obj$testDynamic_results_tidy[[1]]$Gene_Dynamic_Overall == 1, "Dynamic", "NotDynamic"), 
                                                                           levels = c("Dynamic", "NotDynamic"))),
                 BAL_ACCURACY = yardstick::bal_accuracy_vec(truth = factor(obj$testDynamic_results_tidy[[1]]$geneStatus_overall, levels = c("Dynamic", "NotDynamic")), 
                                                            estimate = factor(ifelse(obj$testDynamic_results_tidy[[1]]$Gene_Dynamic_Overall == 1, "Dynamic", "NotDynamic"), 
                                                                                    levels = c("Dynamic", "NotDynamic"))), 
                 NIR = mean(obj$testDynamic_results_tidy[[1]]$geneStatus_overall == "NotDynamic"), 
                 ROC_CURVE = list(yardstick::roc_curve(obj$testDynamic_results_tidy[[1]], 
                                                       truth = factor(geneStatus_overall, levels = c("Dynamic", "NotDynamic")), 
                                                       .estimate = P_Val, 
                                                       event_level = "second") %>% 
                                  mutate(dataset = u)), 
                 PR_CURVE = list(yardstick::pr_curve(obj$testDynamic_results_tidy[[1]], 
                                                     truth = factor(geneStatus_overall, levels = c("Dynamic", "NotDynamic")), 
                                                     .estimate = P_Val, 
                                                     event_level = "second") %>% 
                                 mutate(dataset = u)))
  rm(obj)
  return(perf)
}) %>% 
  purrr::reduce(rbind) %>% 
  mutate(RUNTIME_HOURS = case_when(RUNTIME_UNITS == "secs" ~ RUNTIME / 60^2, 
                                   RUNTIME_UNITS == "mins" ~ RUNTIME / 60, 
                                   RUNTIME_UNITS == "hours" ~ RUNTIME, 
                                   RUNTIME_UNITS == "days" ~ RUNTIME * 24, 
                                   TRUE ~ NA_real_), 
         .before = 10)
```

```{r, echo=FALSE, warning=FALSE, results='hide'}
rm(list = ls(pattern = "scLANE_GEE_panc*")); gc(full = TRUE)
```

## Endocrinogenesis

Lastly, the models from the pancreatic endocrinogenesis dataset. 

```{r}
# 100 cells 
tar_load(scLANE_GEE_endo_DEG_10_CELLS_100_balanced, store = "../store_scLANE_GEE_multi/")
tar_load(scLANE_GEE_endo_DEG_20_CELLS_100_balanced, store = "../store_scLANE_GEE_multi/")
tar_load(scLANE_GEE_endo_DEG_10_CELLS_100_unbalanced, store = "../store_scLANE_GEE_multi/")
tar_load(scLANE_GEE_endo_DEG_20_CELLS_100_unbalanced, store = "../store_scLANE_GEE_multi/")
# 500 cells 
tar_load(scLANE_GEE_endo_DEG_10_CELLS_500_balanced, store = "../store_scLANE_GEE_multi/")
tar_load(scLANE_GEE_endo_DEG_20_CELLS_500_balanced, store = "../store_scLANE_GEE_multi/")
tar_load(scLANE_GEE_endo_DEG_10_CELLS_500_unbalanced, store = "../store_scLANE_GEE_multi/")
tar_load(scLANE_GEE_endo_DEG_20_CELLS_500_unbalanced, store = "../store_scLANE_GEE_multi/")
# 1000 cells 
tar_load(scLANE_GEE_endo_DEG_10_CELLS_1000_balanced, store = "../store_scLANE_GEE_multi/")
tar_load(scLANE_GEE_endo_DEG_20_CELLS_1000_balanced, store = "../store_scLANE_GEE_multi/")
tar_load(scLANE_GEE_endo_DEG_10_CELLS_1000_unbalanced, store = "../store_scLANE_GEE_multi/")
tar_load(scLANE_GEE_endo_DEG_20_CELLS_1000_unbalanced, store = "../store_scLANE_GEE_multi/")
# 2500 cells 
tar_load(scLANE_GEE_endo_DEG_10_CELLS_2500_balanced, store = "../store_scLANE_GEE_multi/")
tar_load(scLANE_GEE_endo_DEG_20_CELLS_2500_balanced, store = "../store_scLANE_GEE_multi/")
tar_load(scLANE_GEE_endo_DEG_10_CELLS_2500_unbalanced, store = "../store_scLANE_GEE_multi/")
tar_load(scLANE_GEE_endo_DEG_20_CELLS_2500_unbalanced, store = "../store_scLANE_GEE_multi/")
# 5000 cells 
tar_load(scLANE_GEE_endo_DEG_10_CELLS_5000_balanced, store = "../store_scLANE_GEE_multi/")
tar_load(scLANE_GEE_endo_DEG_20_CELLS_5000_balanced, store = "../store_scLANE_GEE_multi/")
tar_load(scLANE_GEE_endo_DEG_10_CELLS_5000_unbalanced, store = "../store_scLANE_GEE_multi/")
tar_load(scLANE_GEE_endo_DEG_20_CELLS_5000_unbalanced, store = "../store_scLANE_GEE_multi/")
```

We collate the results as a table. 

```{r}
scLANE_endo_metrics <- purrr::map(ls(pattern = "scLANE_GEE_endo*"), function(u) {
  obj <- eval(as.symbol(u))
  perf <- tibble(DATASET_NAME = u, 
                 MODEL_TYPE = "scLANE", 
                 PERCENT_DEG = paste0(obj$sim_parameters[[1]]$Prop_Dyn_Gene * 100, "%"), 
                 N_CELLS = obj$sim_parameters[[1]]$Cells, 
                 N_GENES = length(obj$testDynamic_results_raw[[1]]), 
                 N_PRED_DYNAMIC_GENES = sum(obj$testDynamic_results_tidy[[1]]$Gene_Dynamic_Overall), 
                 N_TRUE_DYNAMIC_GENES = sum(obj$testDynamic_results_tidy[[1]]$geneStatus_overall == "Dynamic"), 
                 RUNTIME = as.numeric(obj$time_diff[[1]]), 
                 RUNTIME_UNITS = attributes(obj$time_diff[[1]])$units, 
                 MEM_USED = obj$mem_usage[[1]][1] / 1000^2,
                 MEM_UNITS = "MB", 
                 ROC_AUC = yardstick::roc_auc_vec(truth = factor(obj$testDynamic_results_tidy[[1]]$geneStatus_overall, levels = c("Dynamic", "NotDynamic")), 
                                                  estimate = obj$testDynamic_results_tidy[[1]]$P_Val, 
                                                  event_level = "second"), 
                 ACCURACY = yardstick::accuracy_vec(truth = factor(obj$testDynamic_results_tidy[[1]]$geneStatus_overall, levels = c("Dynamic", "NotDynamic")), 
                                                    estimate = factor(ifelse(obj$testDynamic_results_tidy[[1]]$Gene_Dynamic_Overall == 1, "Dynamic", "NotDynamic"), 
                                                                      levels = c("Dynamic", "NotDynamic"))), 
                 SENSITIVITY = yardstick::sens_vec(truth = factor(obj$testDynamic_results_tidy[[1]]$geneStatus_overall, levels = c("Dynamic", "NotDynamic")), 
                                                   estimate = factor(ifelse(obj$testDynamic_results_tidy[[1]]$Gene_Dynamic_Overall == 1, "Dynamic", "NotDynamic"), 
                                                                     levels = c("Dynamic", "NotDynamic"))), 
                 SPECIFICITY = yardstick::spec_vec(truth = factor(obj$testDynamic_results_tidy[[1]]$geneStatus_overall, levels = c("Dynamic", "NotDynamic")), 
                                                   estimate = factor(ifelse(obj$testDynamic_results_tidy[[1]]$Gene_Dynamic_Overall == 1, "Dynamic", "NotDynamic"), 
                                                                     levels = c("Dynamic", "NotDynamic"))), 
                 RECALL = yardstick::recall_vec(truth = factor(obj$testDynamic_results_tidy[[1]]$geneStatus_overall, levels = c("Dynamic", "NotDynamic")), 
                                                estimate = factor(ifelse(obj$testDynamic_results_tidy[[1]]$Gene_Dynamic_Overall == 1, "Dynamic", "NotDynamic"), 
                                                                  levels = c("Dynamic", "NotDynamic"))), 
                 PRECISION = yardstick::precision_vec(truth = factor(obj$testDynamic_results_tidy[[1]]$geneStatus_overall, levels = c("Dynamic", "NotDynamic")), 
                                                      estimate = factor(ifelse(obj$testDynamic_results_tidy[[1]]$Gene_Dynamic_Overall == 1, "Dynamic", "NotDynamic"), 
                                                                        levels = c("Dynamic", "NotDynamic"))),
                 AUC_PR = yardstick::pr_auc_vec(truth = factor(obj$testDynamic_results_tidy[[1]]$geneStatus_overall, levels = c("Dynamic", "NotDynamic")), 
                                                estimate = obj$testDynamic_results_tidy[[1]]$P_Val, 
                                                event_level = "second"),
                 F_MEASURE = yardstick::f_meas_vec(truth = factor(obj$testDynamic_results_tidy[[1]]$geneStatus_overall, levels = c("Dynamic", "NotDynamic")), 
                                                   estimate = factor(ifelse(obj$testDynamic_results_tidy[[1]]$Gene_Dynamic_Overall == 1, "Dynamic", "NotDynamic"), 
                                                                           levels = c("Dynamic", "NotDynamic"))),
                 BAL_ACCURACY = yardstick::bal_accuracy_vec(truth = factor(obj$testDynamic_results_tidy[[1]]$geneStatus_overall, levels = c("Dynamic", "NotDynamic")), 
                                                            estimate = factor(ifelse(obj$testDynamic_results_tidy[[1]]$Gene_Dynamic_Overall == 1, "Dynamic", "NotDynamic"), 
                                                                                    levels = c("Dynamic", "NotDynamic"))), 
                 NIR = mean(obj$testDynamic_results_tidy[[1]]$geneStatus_overall == "NotDynamic"), 
                 ROC_CURVE = list(yardstick::roc_curve(obj$testDynamic_results_tidy[[1]], 
                                                       truth = factor(geneStatus_overall, levels = c("Dynamic", "NotDynamic")), 
                                                       .estimate = P_Val, 
                                                       event_level = "second") %>% 
                                  mutate(dataset = u)), 
                 PR_CURVE = list(yardstick::pr_curve(obj$testDynamic_results_tidy[[1]], 
                                                     truth = factor(geneStatus_overall, levels = c("Dynamic", "NotDynamic")), 
                                                     .estimate = P_Val, 
                                                     event_level = "second") %>% 
                                 mutate(dataset = u)))
  rm(obj)
  return(perf)
}) %>% 
  purrr::reduce(rbind) %>% 
  mutate(RUNTIME_HOURS = case_when(RUNTIME_UNITS == "secs" ~ RUNTIME / 60^2, 
                                   RUNTIME_UNITS == "mins" ~ RUNTIME / 60, 
                                   RUNTIME_UNITS == "hours" ~ RUNTIME, 
                                   RUNTIME_UNITS == "days" ~ RUNTIME * 24, 
                                   TRUE ~ NA_real_), 
         .before = 10)
```

```{r, echo=FALSE, warning=FALSE, results='hide'}
rm(list = ls(pattern = "scLANE_GEE_endo*")); gc(full = TRUE)
```

## Combine Metrics 

We coerce everything to a single table. 

```{r}
scLANE_metrics <- purrr::map(ls(pattern = "scLANE.*metrics"), \(x) eval(as.symbol(x))) %>% 
                  purrr::reduce(rbind) %>% 
                  mutate(DATASET_TYPE = "Multi-subject", 
                         ALLOCATION = if_else(grepl("_unbalanced", DATASET_NAME), "Unbalanced", "Balanced"), 
                         .before = 2) %>% 
                  mutate(PERCENT_DEG = factor(PERCENT_DEG, levels = c("10%", "20%")), 
                         DATE_GENERATED = Sys.Date())
```

# Quality Control 

## Compute Time 

```{r}
ggplot(scLANE_metrics, aes(x = RUNTIME_HOURS)) + 
  geom_histogram(color = "forestgreen", size = 0.5, fill = "forestgreen", alpha = 0.5) + 
  scale_x_continuous(labels = scales::label_number()) + 
  labs(x = "Runtime (hours)", y = "Frequency") + 
  theme_classic(base_size = 14)
```

## Memory Usage 

```{r}
ggplot(scLANE_metrics, aes(x = MEM_USED)) + 
  geom_histogram(color = "forestgreen", size = 0.5, fill = "forestgreen", alpha = 0.5) + 
  scale_x_continuous(labels = scales::label_comma()) + 
  labs(x = "Memory Used (MB)", y = "Frequency") + 
  theme_classic(base_size = 14)
```

## AUC-ROC 

```{r, fig.width=9}
scLANE_metrics %>% 
  pull(ROC_CURVE) %>% 
  purrr::reduce(rbind) %>% 
  left_join((distinct(scLANE_metrics, DATASET_NAME, PERCENT_DEG)), 
            by = c("dataset" = "DATASET_NAME")) %>% 
  ggplot(aes(x = 1 - specificity, y = sensitivity, group = dataset, color = PERCENT_DEG)) + 
  facet_wrap(~PERCENT_DEG) + 
  geom_segment(x = 0, xend = 0, y = 1, yend = 1, color = "black", linetype = "dashed", size = 1) + 
  geom_line(size = 1, alpha = 0.8) + 
  scale_x_continuous(labels = scales::percent_format(accuracy = 1)) + 
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) + 
  scale_color_manual(values = model_palette) + 
  labs(x = "1 - Specificity", 
      y = "Sensitivity", 
      color = "% Dynamic") + 
  theme_classic(base_size = 14) + 
  guides(color = guide_legend(override.aes = list(linewidth = 2, alpha = 1)))
```

```{r, fig.width=9}
scLANE_metrics %>% 
  pull(ROC_CURVE) %>% 
  purrr::reduce(rbind) %>% 
  left_join((distinct(scLANE_metrics, DATASET_NAME, N_CELLS)), 
            by = c("dataset" = "DATASET_NAME")) %>% 
  mutate(N_CELLS = factor(N_CELLS)) %>% 
  ggplot(aes(x = 1 - specificity, y = sensitivity, group = dataset, color = N_CELLS)) + 
  facet_wrap(~paste0("Cells: ", N_CELLS)) + 
  geom_segment(x = 0, xend = 0, y = 1, yend = 1, color = "black", linetype = "dashed", size = 1) + 
  geom_line(size = 1, alpha = 0.8) + 
  scale_x_continuous(labels = scales::percent_format(accuracy = 1)) + 
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) + 
  scale_color_manual(values = model_palette) + 
  labs(x = "1 - Specificity", 
       y = "Sensitivity", 
       color = "Cells") + 
  theme_classic(base_size = 14) + 
  guides(color = guide_legend(override.aes = list(linewidth = 2, alpha = 1)))
```

```{r, fig.width=9}
scLANE_metrics %>% 
  pull(ROC_CURVE) %>% 
  purrr::reduce(rbind) %>% 
  left_join((distinct(scLANE_metrics, DATASET_NAME, ALLOCATION)), 
            by = c("dataset" = "DATASET_NAME")) %>% 
  ggplot(aes(x = 1 - specificity, y = sensitivity, group = dataset, color = ALLOCATION)) + 
  facet_wrap(~paste0("Sample Allocation: ", ALLOCATION)) + 
  geom_segment(x = 0, xend = 0, y = 1, yend = 1, color = "black", linetype = "dashed", size = 1) + 
  geom_line(size = 1, alpha = 0.8) + 
  scale_x_continuous(labels = scales::percent_format(accuracy = 1)) + 
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) + 
  scale_color_manual(values = model_palette) + 
  labs(x = "1 - Specificity", 
       y = "Sensitivity", 
       color = "Sample Allocation") + 
  theme_classic(base_size = 14) + 
  guides(color = guide_legend(override.aes = list(linewidth = 2, alpha = 1)))
```

## Precision-Recall 

```{r, fig.width=9}
scLANE_metrics %>% 
  pull(PR_CURVE) %>% 
  purrr::reduce(rbind) %>% 
  left_join((distinct(scLANE_metrics, DATASET_NAME, PERCENT_DEG)), 
            by = c("dataset" = "DATASET_NAME")) %>% 
  ggplot(aes(x = recall, y = precision, group = dataset, color = PERCENT_DEG)) + 
  facet_wrap(~PERCENT_DEG) + 
  geom_segment(x = 0, xend = 1, y = 1, yend = 0, color = "black", linetype = "dashed", size = 1) + 
  geom_line(size = 1, alpha = 0.8) + 
  scale_x_continuous(labels = scales::percent_format(accuracy = 1)) + 
  scale_y_continuous(limits = c(0, 1), labels = scales::percent_format(accuracy = 1)) +
  scale_color_manual(values = model_palette) + 
  labs(x = "Recall", 
       y = "Precision", 
       color = "% Dynamic") + 
  theme_classic(base_size = 14) + 
  guides(color = guide_legend(override.aes = list(linewidth = 2, alpha = 1)))
```

```{r, fig.width=9}
scLANE_metrics %>% 
  pull(PR_CURVE) %>% 
  purrr::reduce(rbind) %>% 
  left_join((distinct(scLANE_metrics, DATASET_NAME, N_CELLS)), 
            by = c("dataset" = "DATASET_NAME")) %>% 
  mutate(N_CELLS = factor(N_CELLS)) %>% 
  ggplot(aes(x = recall, y = precision, group = dataset, color = N_CELLS)) + 
  facet_wrap(~paste0("Cells: ", N_CELLS)) + 
  geom_segment(x = 0, xend = 1, y = 1, yend = 0, color = "black", linetype = "dashed", size = 1) + 
  geom_line(size = 1, alpha = 0.8) + 
  scale_x_continuous(labels = scales::percent_format(accuracy = 1)) +
  scale_y_continuous(limits = c(0, 1), labels = scales::percent_format(accuracy = 1)) +
  scale_color_manual(values = model_palette) + 
  labs(x = "Recall", 
       y = "Precision", 
       color = "Cells") + 
  theme_classic(base_size = 14) + 
  guides(color = guide_legend(override.aes = list(linewidth = 2, alpha = 1)))
```

```{r, fig.width=9}
scLANE_metrics %>% 
  pull(PR_CURVE) %>% 
  purrr::reduce(rbind) %>% 
  left_join((distinct(scLANE_metrics, DATASET_NAME, ALLOCATION)), 
            by = c("dataset" = "DATASET_NAME")) %>% 
  ggplot(aes(x = recall, y = precision, group = dataset, color = ALLOCATION)) + 
  facet_wrap(~paste0("Sample Allocation: ", ALLOCATION)) + 
  geom_segment(x = 0, xend = 1, y = 1, yend = 0, color = "black", linetype = "dashed", size = 1) + 
  geom_line(size = 1, alpha = 0.8) + 
  scale_x_continuous(labels = scales::percent_format(accuracy = 1)) +
  scale_y_continuous(limits = c(0, 1), labels = scales::percent_format(accuracy = 1)) +
  scale_color_manual(values = model_palette) + 
  labs(x = "Recall", 
       y = "Precision", 
       color = "Sample Allocation") + 
  theme_classic(base_size = 14) + 
  guides(color = guide_legend(override.aes = list(linewidth = 2, alpha = 1)))
```

## Other Classification Metrics 

When interpreting threshold-based metrics like this, it's important to keep in mind that the no information rate for many of these datasets is very high. 

```{r}
select(scLANE_metrics, 
       DATASET_NAME, ACCURACY, SENSITIVITY, SPECIFICITY, ROC_AUC, PRECISION, RECALL, AUC_PR, F_MEASURE, BAL_ACCURACY, NIR) %>% 
  tidyr::pivot_longer(cols = !DATASET_NAME, names_to = "METRIC", values_to = "VALUE") %>% 
  with_groups(METRIC, 
              summarise, 
              mu = mean(VALUE, na.rm = TRUE), 
              sd = sd(VALUE, na.rm = TRUE), 
              med = median(VALUE, na.rm = TRUE), 
              min = min(VALUE, na.rm = TRUE), 
              max = max(VALUE, na.rm = TRUE)) %>% 
  mutate(range = paste0("(", round(min, 2), ", ", round(max, 2), ")"), 
         across(where(is.numeric), round, digits = 2), 
         METRIC = snakecase::to_title_case(METRIC), 
         METRIC = case_when(METRIC == "Nir" ~ "No Information Rate", 
                            METRIC == "Roc Auc" ~ "AUC-ROC", 
                            METRIC == "Auc Pr" ~ "AUC-PR", 
                            METRIC == "F Measure" ~ "F-measure", 
                            METRIC == "Bal Accuracy" ~ "Balanced Accuracy", 
                            TRUE ~ METRIC)) %>% 
  select(-c(min, max)) %>% 
  kableExtra::kbl(col.names = c("Metric", "Mean", "S.D.", "Median", "Range"), 
                  booktabs = TRUE, 
                  caption = paste0("n = ", length(unique(scLANE_metrics$DATASET_NAME)))) %>% 
  kableExtra::kable_classic(full_width = FALSE, "hover")
```

# Save Results

Lastly, we save the metrics table for further use downstream. This file will be turned into a dependency for the downstream analysis pipeline. 

```{r}
saveRDS(scLANE_metrics, file = "/blue/rbacher/j.leary/repos/scLANE-Sims/Data/scLANE_GEE_Metrics_Multi_Subject.Rds")
```

# Session Info 

```{r}
sessioninfo::session_info()
```
