---
title: "`scLANE` Simulation Study - Process `scLANE` (GLM) Multi-subject Models"
subtitle: "UF Dept. of Biostatistics - Bacher Group"
author: "Jack Leary" 
date: "`r Sys.Date()`"
output:
  html_document:
    theme: journal
    highlight: tango
    code_folding: show
    code_download: true 
    toc: true 
    toc_depth: 2
    toc_float: true
    df_print: kable
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE); set.seed(312)  # lucky seed
```

# Libraries 

First we'll load in the packages we need to tidy & analyze our simulation results. 

```{r, results='hide', message=FALSE, warning=FALSE}
library(dplyr)      # data manipulation 
library(ggplot2)    # plots
library(targets)    # pipeline tools
library(paletteer)  # plot colors 
library(patchwork)  # plot combination
```

# Color Palette

We'll be doing some complex visualization, so we'll pick out a good color palette beforehand to make our code more readable & ensure that we don't run in to errors caused by the palette not being long enough. 

```{r, message=FALSE, warning=FALSE}
model_palette <- paletteer_d("ggsci::nrc_npg")
```

# Data 

Now we'll load in the model results generated by running `scLANE` with the GLM backend on the multi-subject simulated datasets. Splitting by the reference dataset used, we'll load the objects & then iterate over them, pulling out the necessary metrics from each one. 

## Brain 

First the simulations from the brain reference. 

```{r}
# 100 cells 
tar_load(scLANE_GLM_brain_DEG_10_CELLS_100_balanced, store = "../store_scLANE_GLM_multi")
tar_load(scLANE_GLM_brain_DEG_20_CELLS_100_balanced, store = "../store_scLANE_GLM_multi")
tar_load(scLANE_GLM_brain_DEG_10_CELLS_100_unbalanced, store = "../store_scLANE_GLM_multi")
tar_load(scLANE_GLM_brain_DEG_20_CELLS_100_unbalanced, store = "../store_scLANE_GLM_multi")
# 500 cells 
tar_load(scLANE_GLM_brain_DEG_10_CELLS_500_balanced, store = "../store_scLANE_GLM_multi")
tar_load(scLANE_GLM_brain_DEG_20_CELLS_500_balanced, store = "../store_scLANE_GLM_multi")
tar_load(scLANE_GLM_brain_DEG_10_CELLS_500_unbalanced, store = "../store_scLANE_GLM_multi")
tar_load(scLANE_GLM_brain_DEG_20_CELLS_500_unbalanced, store = "../store_scLANE_GLM_multi")
# 1000 cells 
tar_load(scLANE_GLM_brain_DEG_10_CELLS_1000_balanced, store = "../store_scLANE_GLM_multi")
tar_load(scLANE_GLM_brain_DEG_20_CELLS_1000_balanced, store = "../store_scLANE_GLM_multi")
tar_load(scLANE_GLM_brain_DEG_10_CELLS_1000_unbalanced, store = "../store_scLANE_GLM_multi")
tar_load(scLANE_GLM_brain_DEG_20_CELLS_1000_unbalanced, store = "../store_scLANE_GLM_multi")
# 2500 cells 
tar_load(scLANE_GLM_brain_DEG_10_CELLS_2500_balanced, store = "../store_scLANE_GLM_multi")
tar_load(scLANE_GLM_brain_DEG_20_CELLS_2500_balanced, store = "../store_scLANE_GLM_multi")
tar_load(scLANE_GLM_brain_DEG_10_CELLS_2500_unbalanced, store = "../store_scLANE_GLM_multi")
tar_load(scLANE_GLM_brain_DEG_20_CELLS_2500_unbalanced, store = "../store_scLANE_GLM_multi")
# 5000 cells 
tar_load(scLANE_GLM_brain_DEG_10_CELLS_5000_balanced, store = "../store_scLANE_GLM_multi")
tar_load(scLANE_GLM_brain_DEG_20_CELLS_5000_balanced, store = "../store_scLANE_GLM_multi")
tar_load(scLANE_GLM_brain_DEG_10_CELLS_5000_unbalanced, store = "../store_scLANE_GLM_multi")
tar_load(scLANE_GLM_brain_DEG_20_CELLS_5000_unbalanced, store = "../store_scLANE_GLM_multi")
```

We coerce the model results to a table.  

```{r}
scLANE_brain_metrics <- purrr::map(ls(pattern = "scLANE_GLM_brain*"), function(u) {
  obj <- eval(as.symbol(u))
  perf <- tibble(DATASET_NAME = u, 
                 MODEL_TYPE = "scLANE", 
                 PERCENT_DEG = paste0(obj$sim_parameters[[1]]$Prop_Dyn_Gene * 100, "%"), 
                 N_CELLS = obj$sim_parameters[[1]]$Cells, 
                 N_GENES = length(obj$testDynamic_results_raw[[1]]), 
                 N_PRED_DYNAMIC_GENES = sum(obj$testDynamic_results_tidy[[1]]$Gene_Dynamic_Overall), 
                 N_TRUE_DYNAMIC_GENES = sum(obj$testDynamic_results_tidy[[1]]$geneStatus_overall == "Dynamic"), 
                 RUNTIME = as.numeric(obj$time_diff[[1]]), 
                 RUNTIME_UNITS = attributes(obj$time_diff[[1]])$units, 
                 MEM_USED = obj$mem_usage[[1]][1] / 1000^2,
                 MEM_UNITS = "MB", 
                 ROC_AUC = yardstick::roc_auc_vec(truth = factor(obj$testDynamic_results_tidy[[1]]$geneStatus_overall, levels = c("Dynamic", "NotDynamic")), 
                                                  estimate = obj$testDynamic_results_tidy[[1]]$P_Val, 
                                                  event_level = "second"), 
                 ACCURACY = yardstick::accuracy_vec(truth = factor(obj$testDynamic_results_tidy[[1]]$geneStatus_overall, levels = c("Dynamic", "NotDynamic")), 
                                                    estimate = factor(ifelse(obj$testDynamic_results_tidy[[1]]$Gene_Dynamic_Overall == 1, "Dynamic", "NotDynamic"), 
                                                                      levels = c("Dynamic", "NotDynamic"))), 
                 SENSITIVITY = yardstick::sens_vec(truth = factor(obj$testDynamic_results_tidy[[1]]$geneStatus_overall, levels = c("Dynamic", "NotDynamic")), 
                                                   estimate = factor(ifelse(obj$testDynamic_results_tidy[[1]]$Gene_Dynamic_Overall == 1, "Dynamic", "NotDynamic"), 
                                                                     levels = c("Dynamic", "NotDynamic"))), 
                 SPECIFICITY = yardstick::spec_vec(truth = factor(obj$testDynamic_results_tidy[[1]]$geneStatus_overall, levels = c("Dynamic", "NotDynamic")), 
                                                   estimate = factor(ifelse(obj$testDynamic_results_tidy[[1]]$Gene_Dynamic_Overall == 1, "Dynamic", "NotDynamic"), 
                                                                     levels = c("Dynamic", "NotDynamic"))), 
                 RECALL = yardstick::recall_vec(truth = factor(obj$testDynamic_results_tidy[[1]]$geneStatus_overall, levels = c("Dynamic", "NotDynamic")), 
                                                estimate = factor(ifelse(obj$testDynamic_results_tidy[[1]]$Gene_Dynamic_Overall == 1, "Dynamic", "NotDynamic"), 
                                                                  levels = c("Dynamic", "NotDynamic"))), 
                 PRECISION = yardstick::precision_vec(truth = factor(obj$testDynamic_results_tidy[[1]]$geneStatus_overall, levels = c("Dynamic", "NotDynamic")), 
                                                      estimate = factor(ifelse(obj$testDynamic_results_tidy[[1]]$Gene_Dynamic_Overall == 1, "Dynamic", "NotDynamic"), 
                                                                        levels = c("Dynamic", "NotDynamic"))),
                 AUC_PR = yardstick::pr_auc_vec(truth = factor(obj$testDynamic_results_tidy[[1]]$geneStatus_overall, levels = c("Dynamic", "NotDynamic")), 
                                                estimate = obj$testDynamic_results_tidy[[1]]$P_Val, 
                                                event_level = "second"),
                 F_MEASURE = yardstick::f_meas_vec(truth = factor(obj$testDynamic_results_tidy[[1]]$geneStatus_overall, levels = c("Dynamic", "NotDynamic")), 
                                                   estimate = factor(ifelse(obj$testDynamic_results_tidy[[1]]$Gene_Dynamic_Overall == 1, "Dynamic", "NotDynamic"), 
                                                                           levels = c("Dynamic", "NotDynamic"))),
                 NIR = mean(obj$testDynamic_results_tidy[[1]]$geneStatus_overall == "NotDynamic"), 
                 ROC_CURVE = list(yardstick::roc_curve(obj$testDynamic_results_tidy[[1]], 
                                                       truth = factor(geneStatus_overall, levels = c("Dynamic", "NotDynamic")), 
                                                       .estimate = P_Val, 
                                                       event_level = "second") %>% 
                                  mutate(dataset = u)), 
                 PR_CURVE = list(yardstick::pr_curve(obj$testDynamic_results_tidy[[1]], 
                                                     truth = factor(geneStatus_overall, levels = c("Dynamic", "NotDynamic")), 
                                                     .estimate = P_Val, 
                                                     event_level = "second") %>% 
                                 mutate(dataset = u)))
  rm(obj)
  return(perf)
}) %>% 
  purrr::reduce(rbind) %>% 
  mutate(RUNTIME_HOURS = case_when(RUNTIME_UNITS == "secs" ~ RUNTIME / 60^2, 
                                   RUNTIME_UNITS == "mins" ~ RUNTIME / 60, 
                                   RUNTIME_UNITS == "hours" ~ RUNTIME, 
                                   RUNTIME_UNITS == "days" ~ RUNTIME * 24, 
                                   TRUE ~ NA_real_), 
         .before = 10)
```

```{r, echo=FALSE, warning=FALSE, results='hide'}
rm(list = ls(pattern = "scLANE_GLM_brain*")); gc(full = TRUE)
```

## Pancreas 

Next the results from the pancreas reference. 

```{r}
# 100 cells 
tar_load(scLANE_GLM_panc_DEG_10_CELLS_100_balanced, store = "../store_scLANE_GLM_multi")
tar_load(scLANE_GLM_panc_DEG_20_CELLS_100_balanced, store = "../store_scLANE_GLM_multi")
tar_load(scLANE_GLM_panc_DEG_10_CELLS_100_unbalanced, store = "../store_scLANE_GLM_multi")
tar_load(scLANE_GLM_panc_DEG_20_CELLS_100_unbalanced, store = "../store_scLANE_GLM_multi")
# 500 cells 
tar_load(scLANE_GLM_panc_DEG_10_CELLS_500_balanced, store = "../store_scLANE_GLM_multi")
tar_load(scLANE_GLM_panc_DEG_20_CELLS_500_balanced, store = "../store_scLANE_GLM_multi")
tar_load(scLANE_GLM_panc_DEG_10_CELLS_500_unbalanced, store = "../store_scLANE_GLM_multi")
tar_load(scLANE_GLM_panc_DEG_20_CELLS_500_unbalanced, store = "../store_scLANE_GLM_multi")
# 1000 cells 
tar_load(scLANE_GLM_panc_DEG_10_CELLS_1000_balanced, store = "../store_scLANE_GLM_multi")
tar_load(scLANE_GLM_panc_DEG_20_CELLS_1000_balanced, store = "../store_scLANE_GLM_multi")
tar_load(scLANE_GLM_panc_DEG_10_CELLS_1000_unbalanced, store = "../store_scLANE_GLM_multi")
tar_load(scLANE_GLM_panc_DEG_20_CELLS_1000_unbalanced, store = "../store_scLANE_GLM_multi")
# 2500 cells 
tar_load(scLANE_GLM_panc_DEG_10_CELLS_2500_balanced, store = "../store_scLANE_GLM_multi")
tar_load(scLANE_GLM_panc_DEG_20_CELLS_2500_balanced, store = "../store_scLANE_GLM_multi")
tar_load(scLANE_GLM_panc_DEG_10_CELLS_2500_unbalanced, store = "../store_scLANE_GLM_multi")
tar_load(scLANE_GLM_panc_DEG_20_CELLS_2500_unbalanced, store = "../store_scLANE_GLM_multi")
# 5000 cells 
tar_load(scLANE_GLM_panc_DEG_10_CELLS_5000_balanced, store = "../store_scLANE_GLM_multi")
tar_load(scLANE_GLM_panc_DEG_20_CELLS_5000_balanced, store = "../store_scLANE_GLM_multi")
tar_load(scLANE_GLM_panc_DEG_10_CELLS_5000_unbalanced, store = "../store_scLANE_GLM_multi")
tar_load(scLANE_GLM_panc_DEG_20_CELLS_5000_unbalanced, store = "../store_scLANE_GLM_multi")
```

Again we format the model results in a table. 

```{r}
scLANE_panc_metrics <- purrr::map(ls(pattern = "scLANE_GLM_panc*"), function(u) {
  obj <- eval(as.symbol(u))
  perf <- tibble(DATASET_NAME = u, 
                 MODEL_TYPE = "scLANE", 
                 PERCENT_DEG = paste0(obj$sim_parameters[[1]]$Prop_Dyn_Gene * 100, "%"), 
                 N_CELLS = obj$sim_parameters[[1]]$Cells, 
                 N_GENES = length(obj$testDynamic_results_raw[[1]]), 
                 N_PRED_DYNAMIC_GENES = sum(obj$testDynamic_results_tidy[[1]]$Gene_Dynamic_Overall), 
                 N_TRUE_DYNAMIC_GENES = sum(obj$testDynamic_results_tidy[[1]]$geneStatus_overall == "Dynamic"), 
                 RUNTIME = as.numeric(obj$time_diff[[1]]), 
                 RUNTIME_UNITS = attributes(obj$time_diff[[1]])$units, 
                 MEM_USED = obj$mem_usage[[1]][1] / 1000^2,
                 MEM_UNITS = "MB", 
                 ROC_AUC = yardstick::roc_auc_vec(truth = factor(obj$testDynamic_results_tidy[[1]]$geneStatus_overall, levels = c("Dynamic", "NotDynamic")), 
                                                  estimate = obj$testDynamic_results_tidy[[1]]$P_Val, 
                                                  event_level = "second"), 
                 ACCURACY = yardstick::accuracy_vec(truth = factor(obj$testDynamic_results_tidy[[1]]$geneStatus_overall, levels = c("Dynamic", "NotDynamic")), 
                                                    estimate = factor(ifelse(obj$testDynamic_results_tidy[[1]]$Gene_Dynamic_Overall == 1, "Dynamic", "NotDynamic"), 
                                                                      levels = c("Dynamic", "NotDynamic"))), 
                 SENSITIVITY = yardstick::sens_vec(truth = factor(obj$testDynamic_results_tidy[[1]]$geneStatus_overall, levels = c("Dynamic", "NotDynamic")), 
                                                   estimate = factor(ifelse(obj$testDynamic_results_tidy[[1]]$Gene_Dynamic_Overall == 1, "Dynamic", "NotDynamic"), 
                                                                     levels = c("Dynamic", "NotDynamic"))), 
                 SPECIFICITY = yardstick::spec_vec(truth = factor(obj$testDynamic_results_tidy[[1]]$geneStatus_overall, levels = c("Dynamic", "NotDynamic")), 
                                                   estimate = factor(ifelse(obj$testDynamic_results_tidy[[1]]$Gene_Dynamic_Overall == 1, "Dynamic", "NotDynamic"), 
                                                                     levels = c("Dynamic", "NotDynamic"))), 
                 RECALL = yardstick::recall_vec(truth = factor(obj$testDynamic_results_tidy[[1]]$geneStatus_overall, levels = c("Dynamic", "NotDynamic")), 
                                                estimate = factor(ifelse(obj$testDynamic_results_tidy[[1]]$Gene_Dynamic_Overall == 1, "Dynamic", "NotDynamic"), 
                                                                  levels = c("Dynamic", "NotDynamic"))), 
                 PRECISION = yardstick::precision_vec(truth = factor(obj$testDynamic_results_tidy[[1]]$geneStatus_overall, levels = c("Dynamic", "NotDynamic")), 
                                                      estimate = factor(ifelse(obj$testDynamic_results_tidy[[1]]$Gene_Dynamic_Overall == 1, "Dynamic", "NotDynamic"), 
                                                                        levels = c("Dynamic", "NotDynamic"))),
                 AUC_PR = yardstick::pr_auc_vec(truth = factor(obj$testDynamic_results_tidy[[1]]$geneStatus_overall, levels = c("Dynamic", "NotDynamic")), 
                                                estimate = obj$testDynamic_results_tidy[[1]]$P_Val, 
                                                event_level = "second"),
                 F_MEASURE = yardstick::f_meas_vec(truth = factor(obj$testDynamic_results_tidy[[1]]$geneStatus_overall, levels = c("Dynamic", "NotDynamic")), 
                                                   estimate = factor(ifelse(obj$testDynamic_results_tidy[[1]]$Gene_Dynamic_Overall == 1, "Dynamic", "NotDynamic"), 
                                                                           levels = c("Dynamic", "NotDynamic"))),
                 NIR = mean(obj$testDynamic_results_tidy[[1]]$geneStatus_overall == "NotDynamic"), 
                 ROC_CURVE = list(yardstick::roc_curve(obj$testDynamic_results_tidy[[1]], 
                                                       truth = factor(geneStatus_overall, levels = c("Dynamic", "NotDynamic")), 
                                                       .estimate = P_Val, 
                                                       event_level = "second") %>% 
                                  mutate(dataset = u)), 
                 PR_CURVE = list(yardstick::pr_curve(obj$testDynamic_results_tidy[[1]], 
                                                     truth = factor(geneStatus_overall, levels = c("Dynamic", "NotDynamic")), 
                                                     .estimate = P_Val, 
                                                     event_level = "second") %>% 
                                 mutate(dataset = u)))
  rm(obj)
  return(perf)
}) %>% 
  purrr::reduce(rbind) %>% 
  mutate(RUNTIME_HOURS = case_when(RUNTIME_UNITS == "secs" ~ RUNTIME / 60^2, 
                                   RUNTIME_UNITS == "mins" ~ RUNTIME / 60, 
                                   RUNTIME_UNITS == "hours" ~ RUNTIME, 
                                   RUNTIME_UNITS == "days" ~ RUNTIME * 24, 
                                   TRUE ~ NA_real_), 
         .before = 10)
```

```{r, echo=FALSE, warning=FALSE, results='hide'}
rm(list = ls(pattern = "scLANE_GLM_panc*")); gc(full = TRUE)
```

## Endocrinogenesis

Lastly, the models from the pancreatic endocrinogenesis dataset. 

```{r}
# 100 cells 
tar_load(scLANE_GLM_endo_DEG_10_CELLS_100_balanced, store = "../store_scLANE_GLM_multi")
tar_load(scLANE_GLM_endo_DEG_20_CELLS_100_balanced, store = "../store_scLANE_GLM_multi")
tar_load(scLANE_GLM_endo_DEG_10_CELLS_100_unbalanced, store = "../store_scLANE_GLM_multi")
tar_load(scLANE_GLM_endo_DEG_20_CELLS_100_unbalanced, store = "../store_scLANE_GLM_multi")
# 500 cells 
tar_load(scLANE_GLM_endo_DEG_10_CELLS_500_balanced, store = "../store_scLANE_GLM_multi")
tar_load(scLANE_GLM_endo_DEG_20_CELLS_500_balanced, store = "../store_scLANE_GLM_multi")
tar_load(scLANE_GLM_endo_DEG_10_CELLS_500_unbalanced, store = "../store_scLANE_GLM_multi")
tar_load(scLANE_GLM_endo_DEG_20_CELLS_500_unbalanced, store = "../store_scLANE_GLM_multi")
# 1000 cells 
tar_load(scLANE_GLM_endo_DEG_10_CELLS_1000_balanced, store = "../store_scLANE_GLM_multi")
tar_load(scLANE_GLM_endo_DEG_20_CELLS_1000_balanced, store = "../store_scLANE_GLM_multi")
tar_load(scLANE_GLM_endo_DEG_10_CELLS_1000_unbalanced, store = "../store_scLANE_GLM_multi")
tar_load(scLANE_GLM_endo_DEG_20_CELLS_1000_unbalanced, store = "../store_scLANE_GLM_multi")
# 2500 cells 
tar_load(scLANE_GLM_endo_DEG_10_CELLS_2500_balanced, store = "../store_scLANE_GLM_multi")
tar_load(scLANE_GLM_endo_DEG_20_CELLS_2500_balanced, store = "../store_scLANE_GLM_multi")
tar_load(scLANE_GLM_endo_DEG_10_CELLS_2500_unbalanced, store = "../store_scLANE_GLM_multi")
tar_load(scLANE_GLM_endo_DEG_20_CELLS_2500_unbalanced, store = "../store_scLANE_GLM_multi")
# 5000 cells 
tar_load(scLANE_GLM_endo_DEG_10_CELLS_5000_balanced, store = "../store_scLANE_GLM_multi")
tar_load(scLANE_GLM_endo_DEG_20_CELLS_5000_balanced, store = "../store_scLANE_GLM_multi")
tar_load(scLANE_GLM_endo_DEG_10_CELLS_5000_unbalanced, store = "../store_scLANE_GLM_multi")
tar_load(scLANE_GLM_endo_DEG_20_CELLS_5000_unbalanced, store = "../store_scLANE_GLM_multi")
```

We collate the results as a table. 

```{r}
scLANE_endo_metrics <- purrr::map(ls(pattern = "scLANE_GLM_endo*"), function(u) {
  obj <- eval(as.symbol(u))
  perf <- tibble(DATASET_NAME = u, 
                 MODEL_TYPE = "scLANE", 
                 PERCENT_DEG = paste0(obj$sim_parameters[[1]]$Prop_Dyn_Gene * 100, "%"), 
                 N_CELLS = obj$sim_parameters[[1]]$Cells, 
                 N_GENES = length(obj$testDynamic_results_raw[[1]]), 
                 N_PRED_DYNAMIC_GENES = sum(obj$testDynamic_results_tidy[[1]]$Gene_Dynamic_Overall), 
                 N_TRUE_DYNAMIC_GENES = sum(obj$testDynamic_results_tidy[[1]]$geneStatus_overall == "Dynamic"), 
                 RUNTIME = as.numeric(obj$time_diff[[1]]), 
                 RUNTIME_UNITS = attributes(obj$time_diff[[1]])$units, 
                 MEM_USED = obj$mem_usage[[1]][1] / 1000^2,
                 MEM_UNITS = "MB", 
                 ROC_AUC = yardstick::roc_auc_vec(truth = factor(obj$testDynamic_results_tidy[[1]]$geneStatus_overall, levels = c("Dynamic", "NotDynamic")), 
                                                  estimate = obj$testDynamic_results_tidy[[1]]$P_Val, 
                                                  event_level = "second"), 
                 ACCURACY = yardstick::accuracy_vec(truth = factor(obj$testDynamic_results_tidy[[1]]$geneStatus_overall, levels = c("Dynamic", "NotDynamic")), 
                                                    estimate = factor(ifelse(obj$testDynamic_results_tidy[[1]]$Gene_Dynamic_Overall == 1, "Dynamic", "NotDynamic"), 
                                                                      levels = c("Dynamic", "NotDynamic"))), 
                 SENSITIVITY = yardstick::sens_vec(truth = factor(obj$testDynamic_results_tidy[[1]]$geneStatus_overall, levels = c("Dynamic", "NotDynamic")), 
                                                   estimate = factor(ifelse(obj$testDynamic_results_tidy[[1]]$Gene_Dynamic_Overall == 1, "Dynamic", "NotDynamic"), 
                                                                     levels = c("Dynamic", "NotDynamic"))), 
                 SPECIFICITY = yardstick::spec_vec(truth = factor(obj$testDynamic_results_tidy[[1]]$geneStatus_overall, levels = c("Dynamic", "NotDynamic")), 
                                                   estimate = factor(ifelse(obj$testDynamic_results_tidy[[1]]$Gene_Dynamic_Overall == 1, "Dynamic", "NotDynamic"), 
                                                                     levels = c("Dynamic", "NotDynamic"))), 
                 RECALL = yardstick::recall_vec(truth = factor(obj$testDynamic_results_tidy[[1]]$geneStatus_overall, levels = c("Dynamic", "NotDynamic")), 
                                                estimate = factor(ifelse(obj$testDynamic_results_tidy[[1]]$Gene_Dynamic_Overall == 1, "Dynamic", "NotDynamic"), 
                                                                  levels = c("Dynamic", "NotDynamic"))), 
                 PRECISION = yardstick::precision_vec(truth = factor(obj$testDynamic_results_tidy[[1]]$geneStatus_overall, levels = c("Dynamic", "NotDynamic")), 
                                                      estimate = factor(ifelse(obj$testDynamic_results_tidy[[1]]$Gene_Dynamic_Overall == 1, "Dynamic", "NotDynamic"), 
                                                                        levels = c("Dynamic", "NotDynamic"))),
                 AUC_PR = yardstick::pr_auc_vec(truth = factor(obj$testDynamic_results_tidy[[1]]$geneStatus_overall, levels = c("Dynamic", "NotDynamic")), 
                                                estimate = obj$testDynamic_results_tidy[[1]]$P_Val, 
                                                event_level = "second"),
                 F_MEASURE = yardstick::f_meas_vec(truth = factor(obj$testDynamic_results_tidy[[1]]$geneStatus_overall, levels = c("Dynamic", "NotDynamic")), 
                                                   estimate = factor(ifelse(obj$testDynamic_results_tidy[[1]]$Gene_Dynamic_Overall == 1, "Dynamic", "NotDynamic"), 
                                                                           levels = c("Dynamic", "NotDynamic"))),
                 NIR = mean(obj$testDynamic_results_tidy[[1]]$geneStatus_overall == "NotDynamic"), 
                 ROC_CURVE = list(yardstick::roc_curve(obj$testDynamic_results_tidy[[1]], 
                                                       truth = factor(geneStatus_overall, levels = c("Dynamic", "NotDynamic")), 
                                                       .estimate = P_Val, 
                                                       event_level = "second") %>% 
                                  mutate(dataset = u)), 
                 PR_CURVE = list(yardstick::pr_curve(obj$testDynamic_results_tidy[[1]], 
                                                     truth = factor(geneStatus_overall, levels = c("Dynamic", "NotDynamic")), 
                                                     .estimate = P_Val, 
                                                     event_level = "second") %>% 
                                 mutate(dataset = u)))
  rm(obj)
  return(perf)
}) %>% 
  purrr::reduce(rbind) %>% 
  mutate(RUNTIME_HOURS = case_when(RUNTIME_UNITS == "secs" ~ RUNTIME / 60^2, 
                                   RUNTIME_UNITS == "mins" ~ RUNTIME / 60, 
                                   RUNTIME_UNITS == "hours" ~ RUNTIME, 
                                   RUNTIME_UNITS == "days" ~ RUNTIME * 24, 
                                   TRUE ~ NA_real_), 
         .before = 10)
```

```{r, echo=FALSE, warning=FALSE, results='hide'}
rm(list = ls(pattern = "scLANE_GLM_endo*")); gc(full = TRUE)
```

## Combine Metrics 

We coerce everything to a single table. 

```{r}
scLANE_metrics <- purrr::map(ls(pattern = "scLANE.*metrics"), \(x) eval(as.symbol(x))) %>% 
                  purrr::reduce(rbind) %>% 
                  mutate(DATASET_TYPE = "Multi-subject", 
                         ALLOCATION = if_else(grepl("_unbalanced", DATASET_NAME), "Unbalanced", "Balanced"), 
                         .before = 2) %>% 
                  mutate(PERCENT_DEG = factor(PERCENT_DEG, levels = c("10%", "20%")), 
                         DATE_GENERATED = Sys.Date())
```

# Quality Control 

## Compute Time 

## Memory Usage 

## AUC-ROC 

## Precision-Recall 

## Other Classification Metrics 


# Save Results

Lastly, we save the metrics table for further use downstream. This file will be turned into a dependency for the downstream analysis pipeline. 

```{r}
saveRDS(scLANE_metrics, file = "../Data/scLANE_GLM_Metrics_Multi_Subject.Rds")
```

# Session Info 

```{r}
sessioninfo::session_info()
```
