---
title: "`scLANE` Simulation Study Results Analysis"
subtitle: "University of Florida - Dept. of Biostatistics - Bacher Group"
author: "Jack Leary"
date: "`r Sys.Date()`"
output:
  html_document:
    theme: paper
    highlight: tango
    code_download: true
    code_folding: show
    toc: true
    toc_depth: 3
    toc_float: true
    df_print: kable
---

```{r setup}
knitr::opts_chunk$set(message = FALSE, warning = FALSE, echo = TRUE); set.seed(312)  # lucky seed
```

# Libraries

```{r libraries, results='hide'}
library(dplyr)        # data manipulation
library(ggplot2)      # plots
library(targets)      # pipeline tools 
library(tarchetypes)  # more pipeline tools 
```

# Load Targets

Because `targets` won't recognize the dependencies of this document unless we explicitly list them out by name (loading them programmatically with `tidyselect` functions doesn't work), this incredibly verbose code is unfortunately necessary. For each of our types of models, we'll load in the data from the lung and pancreas reference dataset runs, land everything in a list, then process the results and land them in a `tibble` containing dataset attributes, performance metrics, and more. This tidy format will allow us to easily visualize and summarize our models' performance. 

## Single Subject 

### `scLANE`

#### Lung

```{r, results='hide'}
# 100 cells
tar_load(scLANE_res_lung_DEG_01_CELLS_100)
tar_load(scLANE_res_lung_DEG_05_CELLS_100)
tar_load(scLANE_res_lung_DEG_10_CELLS_100)
tar_load(scLANE_res_lung_DEG_20_CELLS_100)
# 500 cells
tar_load(scLANE_res_lung_DEG_01_CELLS_500)
tar_load(scLANE_res_lung_DEG_05_CELLS_500)
tar_load(scLANE_res_lung_DEG_10_CELLS_500)
tar_load(scLANE_res_lung_DEG_20_CELLS_500)
# 1,000 cells
tar_load(scLANE_res_lung_DEG_01_CELLS_1000)
tar_load(scLANE_res_lung_DEG_05_CELLS_1000)
tar_load(scLANE_res_lung_DEG_10_CELLS_1000)
tar_load(scLANE_res_lung_DEG_20_CELLS_1000)
# 2,500 cells
tar_load(scLANE_res_lung_DEG_01_CELLS_2500)
tar_load(scLANE_res_lung_DEG_05_CELLS_2500)
tar_load(scLANE_res_lung_DEG_10_CELLS_2500)
tar_load(scLANE_res_lung_DEG_20_CELLS_2500)
# 5,000 cells
tar_load(scLANE_res_lung_DEG_01_CELLS_5000)
tar_load(scLANE_res_lung_DEG_05_CELLS_5000)
tar_load(scLANE_res_lung_DEG_10_CELLS_5000)
tar_load(scLANE_res_lung_DEG_20_CELLS_5000)
# coerce to list
scLANE_single_subj_lung_list <- purrr::map(ls(pattern = "scLANE_res_lung*"), \(x) eval(as.symbol(x)))
names(scLANE_single_subj_lung_list) <- ls(pattern = "scLANE_res_lung*")
rm(list = ls(pattern = "scLANE_res_lung*")); gc(verbose = FALSE, full = TRUE)
```



```{r}
purrr::imap(scLANE_single_subj_lung_list, 
            function(x, y) {
  tibble(
    DATASET_NAME = y, 
    MODEL_TYPE = "scLANE GLM", 
    PERCENT_DEG = as.numeric(stringr::str_match(y, "_DEG_[0-9]*") %>% stringr::str_remove("_DEG_")) / 100, 
    N_CELLS = as.numeric(stringr::str_match(y, "_CELLS_[0-9]*") %>% stringr::str_remove("_CELLS_")), 
    N_GENES = length(unique(names(x$testDynamic_results_raw[[1]]))), 
    RUNTIME = as.numeric(x$time_diff[[1]]), 
    RUNTIME_UNITS = attributes(x$time_diff[[1]])$units, 
    MEM_USED = x$mem_usage[[1]][1] / 1000^2,  # convert to megabytes
    MEM_UNITS = "MB", 
    ROC_AUC = yardstick::roc_auc(x$testDynamic_results_tidy[[1]], 
                                 truth = factor(geneStatus, levels = c("Dynamic", "NotDynamic")), 
                                 .estimate = P_Val_Adj, 
                                 event_level = "second") %>% pull(.estimate), 
    ACCURACY = yardstick::accuracy(x$testDynamic_results_tidy[[1]], 
                                   truth = factor(geneStatus, levels = c("Dynamic", "NotDynamic")), 
                                   estimate = factor(ifelse(Gene_Dynamic_Overall == 1, "Dynamic", "NotDynamic"), 
                                                     levels = c("Dynamic", "NotDynamic"))) %>% 
               pull(.estimate), 
    SENSITIVITY = yardstick::sens(x$testDynamic_results_tidy[[1]], 
                                  truth = factor(geneStatus, levels = c("Dynamic", "NotDynamic")), 
                                  estimate = factor(ifelse(Gene_Dynamic_Overall == 1, "Dynamic", "NotDynamic"), 
                                                    levels = c("Dynamic", "NotDynamic"))) %>% 
                  pull(.estimate), 
    SPECIFICITY = yardstick::spec(x$testDynamic_results_tidy[[1]], 
                                  truth = factor(geneStatus, levels = c("Dynamic", "NotDynamic")), 
                                  estimate = factor(ifelse(Gene_Dynamic_Overall == 1, "Dynamic", "NotDynamic"), 
                                                    levels = c("Dynamic", "NotDynamic"))) %>% 
                  pull(.estimate), 
    NIR = mean(x$testDynamic_results_tidy[[1]]$geneStatus == "NotDynamic"), 
    ROC_CURVE = list(yardstick::roc_curve(x$testDynamic_results_tidy[[1]], 
                                          truth = factor(geneStatus, levels = c("Dynamic", "NotDynamic")), 
                                          .estimate = P_Val_Adj, 
                                          event_level = "second") %>% 
                       mutate(dataset = y))
  )
}) %>% 
  purrr::reduce(rbind) %>% 
  mutate(RUNTIME_HOURS = case_when(RUNTIME_UNITS == "secs" ~ RUNTIME / 60^2, 
                                   RUNTIME_UNITS == "mins" ~ RUNTIME / 60, 
                                   RUNTIME_UNITS == "hours" ~ RUNTIME, 
                                   RUNTIME_UNITS == "days" ~ RUNTIME * 24, 
                                   TRUE ~ NA_real_), 
         .before = 8) %>% 
  mutate(DATASET_TYPE = "Single subject", .before = 2) -> scLANE_single_subj_lung_metrics
```

#### Pancreas

```{r, results='hide'}
# 100 cells
tar_load(scLANE_res_panc_DEG_01_CELLS_100)
tar_load(scLANE_res_panc_DEG_05_CELLS_100)
tar_load(scLANE_res_panc_DEG_10_CELLS_100)
tar_load(scLANE_res_panc_DEG_20_CELLS_100)
# 500 cells
tar_load(scLANE_res_panc_DEG_01_CELLS_500)
tar_load(scLANE_res_panc_DEG_05_CELLS_500)
tar_load(scLANE_res_panc_DEG_10_CELLS_500)
tar_load(scLANE_res_panc_DEG_20_CELLS_500)
# 1,000 cells
tar_load(scLANE_res_panc_DEG_01_CELLS_1000)
tar_load(scLANE_res_panc_DEG_05_CELLS_1000)
tar_load(scLANE_res_panc_DEG_10_CELLS_1000)
tar_load(scLANE_res_panc_DEG_20_CELLS_1000)
# 2,500 cells
tar_load(scLANE_res_panc_DEG_01_CELLS_2500)
tar_load(scLANE_res_panc_DEG_05_CELLS_2500)
tar_load(scLANE_res_panc_DEG_10_CELLS_2500)
tar_load(scLANE_res_panc_DEG_20_CELLS_2500)
# 5,000 cells
tar_load(scLANE_res_panc_DEG_01_CELLS_5000)
tar_load(scLANE_res_panc_DEG_05_CELLS_5000)
tar_load(scLANE_res_panc_DEG_10_CELLS_5000)
tar_load(scLANE_res_panc_DEG_20_CELLS_5000)
# coerce to list
scLANE_single_subj_panc_list <- purrr::map(ls(pattern = "scLANE_res_panc*"), \(x) eval(as.symbol(x)))
names(scLANE_single_subj_panc_list) <- ls(pattern = "scLANE_res_panc*")
rm(list = ls(pattern = "scLANE_res_panc*")); gc(verbose = FALSE, full = TRUE)
```



```{r}
purrr::imap(scLANE_single_subj_panc_list, 
            function(x, y) {
  tibble(
    DATASET_NAME = y, 
    MODEL_TYPE = "scLANE GLM", 
    PERCENT_DEG = as.numeric(stringr::str_match(y, "_DEG_[0-9]*") %>% stringr::str_remove("_DEG_")) / 100, 
    N_CELLS = as.numeric(stringr::str_match(y, "_CELLS_[0-9]*") %>% stringr::str_remove("_CELLS_")), 
    N_GENES = length(unique(names(x$testDynamic_results_raw[[1]]))), 
    RUNTIME = as.numeric(x$time_diff[[1]]), 
    RUNTIME_UNITS = attributes(x$time_diff[[1]])$units, 
    MEM_USED = x$mem_usage[[1]][1] / 1000^2,  # convert to megabytes
    MEM_UNITS = "MB", 
    ROC_AUC = yardstick::roc_auc(x$testDynamic_results_tidy[[1]], 
                                 truth = factor(geneStatus, levels = c("Dynamic", "NotDynamic")), 
                                 .estimate = P_Val_Adj, 
                                 event_level = "second") %>% pull(.estimate), 
    ACCURACY = yardstick::accuracy(x$testDynamic_results_tidy[[1]], 
                                   truth = factor(geneStatus, levels = c("Dynamic", "NotDynamic")), 
                                   estimate = factor(ifelse(Gene_Dynamic_Overall == 1, "Dynamic", "NotDynamic"), 
                                                     levels = c("Dynamic", "NotDynamic"))) %>% 
               pull(.estimate), 
    SENSITIVITY = yardstick::sens(x$testDynamic_results_tidy[[1]], 
                                  truth = factor(geneStatus, levels = c("Dynamic", "NotDynamic")), 
                                  estimate = factor(ifelse(Gene_Dynamic_Overall == 1, "Dynamic", "NotDynamic"), 
                                                    levels = c("Dynamic", "NotDynamic"))) %>% 
                  pull(.estimate), 
    SPECIFICITY = yardstick::spec(x$testDynamic_results_tidy[[1]], 
                                  truth = factor(geneStatus, levels = c("Dynamic", "NotDynamic")), 
                                  estimate = factor(ifelse(Gene_Dynamic_Overall == 1, "Dynamic", "NotDynamic"), 
                                                    levels = c("Dynamic", "NotDynamic"))) %>% 
                  pull(.estimate), 
    NIR = mean(x$testDynamic_results_tidy[[1]]$geneStatus == "NotDynamic"), 
    ROC_CURVE = list(yardstick::roc_curve(x$testDynamic_results_tidy[[1]], 
                                          truth = factor(geneStatus, levels = c("Dynamic", "NotDynamic")), 
                                          .estimate = P_Val_Adj, 
                                          event_level = "second") %>% 
                       mutate(dataset = y))
  )
}) %>% 
  purrr::reduce(rbind) %>% 
  mutate(RUNTIME_HOURS = case_when(RUNTIME_UNITS == "secs" ~ RUNTIME / 60^2, 
                                   RUNTIME_UNITS == "mins" ~ RUNTIME / 60, 
                                   RUNTIME_UNITS == "hours" ~ RUNTIME, 
                                   RUNTIME_UNITS == "days" ~ RUNTIME * 24, 
                                   TRUE ~ NA_real_), 
         .before = 8) %>% 
  mutate(DATASET_TYPE = "Single subject", .before = 2) -> scLANE_single_subj_panc_metrics
```

### `tradeSeq`

#### Lung

```{r, results='hide'}
# 100 cells
tar_load(tradeSeq_res_lung_DEG_01_CELLS_100)
tar_load(tradeSeq_res_lung_DEG_05_CELLS_100)
tar_load(tradeSeq_res_lung_DEG_10_CELLS_100)
tar_load(tradeSeq_res_lung_DEG_20_CELLS_100)
# 500 cells
tar_load(tradeSeq_res_lung_DEG_01_CELLS_500)
tar_load(tradeSeq_res_lung_DEG_05_CELLS_500)
tar_load(tradeSeq_res_lung_DEG_10_CELLS_500)
tar_load(tradeSeq_res_lung_DEG_20_CELLS_500)
# 1,000 cells
tar_load(tradeSeq_res_lung_DEG_01_CELLS_1000)
tar_load(tradeSeq_res_lung_DEG_05_CELLS_1000)
tar_load(tradeSeq_res_lung_DEG_10_CELLS_1000)
tar_load(tradeSeq_res_lung_DEG_20_CELLS_1000)
# 2,500 cells
tar_load(tradeSeq_res_lung_DEG_01_CELLS_2500)
tar_load(tradeSeq_res_lung_DEG_05_CELLS_2500)
tar_load(tradeSeq_res_lung_DEG_10_CELLS_2500)
tar_load(tradeSeq_res_lung_DEG_20_CELLS_2500)
# 5,000 cells
tar_load(tradeSeq_res_lung_DEG_01_CELLS_5000)
tar_load(tradeSeq_res_lung_DEG_05_CELLS_5000)
tar_load(tradeSeq_res_lung_DEG_10_CELLS_5000)
tar_load(tradeSeq_res_lung_DEG_20_CELLS_5000)
# coerce to list 
tradeSeq_single_subj_lung_list <- purrr::map(ls(pattern = "tradeSeq_res_lung*"), \(x) eval(as.symbol(x)))
names(tradeSeq_single_subj_lung_list) <- ls(pattern = "tradeSeq_res_lung*")
rm(list = ls(pattern = "tradeSeq_res_lung*")); gc(verbose = FALSE, full = TRUE)
```



```{r}
purrr::imap(tradeSeq_single_subj_lung_list, 
            function(x, y) {
  tibble(
    DATASET_NAME = y, 
    MODEL_TYPE = "tradeSeq GAM", 
    PERCENT_DEG = as.numeric(stringr::str_match(y, "_DEG_[0-9]*") %>% stringr::str_remove("_DEG_")) / 100, 
    N_CELLS = as.numeric(stringr::str_match(y, "_CELLS_[0-9]*") %>% stringr::str_remove("_CELLS_")), 
    N_GENES = length(unique(names(x$tradeSeq_results_raw[[1]]))), 
    RUNTIME = as.numeric(x$time_diff[[1]]), 
    RUNTIME_UNITS = attributes(x$time_diff[[1]])$units, 
    MEM_USED = x$mem_usage[[1]][1] / 1000^2,  # convert to megabytes
    MEM_UNITS = "MB", 
    ROC_AUC = yardstick::roc_auc(x$tradeSeq_results_tidy[[1]], 
                                 truth = factor(geneStatus, levels = c("Dynamic", "NotDynamic")), 
                                 .estimate = pvalue_adj, 
                                 event_level = "second") %>% pull(.estimate), 
    ACCURACY = yardstick::accuracy(x$tradeSeq_results_tidy[[1]], 
                                   truth = factor(geneStatus, levels = c("Dynamic", "NotDynamic")), 
                                   estimate = factor(ifelse(gene_dynamic_overall == 1, "Dynamic", "NotDynamic"), 
                                                     levels = c("Dynamic", "NotDynamic"))) %>% 
               pull(.estimate), 
    SENSITIVITY = yardstick::sens(x$tradeSeq_results_tidy[[1]], 
                                  truth = factor(geneStatus, levels = c("Dynamic", "NotDynamic")), 
                                  estimate = factor(ifelse(gene_dynamic_overall == 1, "Dynamic", "NotDynamic"), 
                                                    levels = c("Dynamic", "NotDynamic"))) %>% 
                  pull(.estimate), 
    SPECIFICITY = yardstick::spec(x$tradeSeq_results_tidy[[1]], 
                                  truth = factor(geneStatus, levels = c("Dynamic", "NotDynamic")), 
                                  estimate = factor(ifelse(gene_dynamic_overall == 1, "Dynamic", "NotDynamic"), 
                                                    levels = c("Dynamic", "NotDynamic"))) %>% 
                  pull(.estimate), 
    NIR = mean(x$tradeSeq_results_tidy[[1]]$geneStatus == "NotDynamic"), 
    ROC_CURVE = list(yardstick::roc_curve(x$tradeSeq_results_tidy[[1]], 
                                          truth = factor(geneStatus, levels = c("Dynamic", "NotDynamic")), 
                                          .estimate = pvalue_adj, 
                                          event_level = "second") %>% 
                       mutate(dataset = y))
  )
}) %>% 
  purrr::reduce(rbind) %>% 
  mutate(RUNTIME_HOURS = case_when(RUNTIME_UNITS == "secs" ~ RUNTIME / 60^2, 
                                   RUNTIME_UNITS == "mins" ~ RUNTIME / 60, 
                                   RUNTIME_UNITS == "hours" ~ RUNTIME, 
                                   RUNTIME_UNITS == "days" ~ RUNTIME * 24, 
                                   TRUE ~ NA_real_), 
         .before = 8)  %>% 
  mutate(DATASET_TYPE = "Single subject", .before = 2) -> tradeSeq_single_subj_lung_metrics
```

#### Pancreas 

```{r}
# 100 cells
tar_load(tradeSeq_res_panc_DEG_01_CELLS_100)
tar_load(tradeSeq_res_panc_DEG_05_CELLS_100)
tar_load(tradeSeq_res_panc_DEG_10_CELLS_100)
tar_load(tradeSeq_res_panc_DEG_20_CELLS_100)
# 500 cells
tar_load(tradeSeq_res_panc_DEG_01_CELLS_500)
tar_load(tradeSeq_res_panc_DEG_05_CELLS_500)
tar_load(tradeSeq_res_panc_DEG_10_CELLS_500)
tar_load(tradeSeq_res_panc_DEG_20_CELLS_500)
# 1,000 cells
tar_load(tradeSeq_res_panc_DEG_01_CELLS_1000)
tar_load(tradeSeq_res_panc_DEG_05_CELLS_1000)
tar_load(tradeSeq_res_panc_DEG_10_CELLS_1000)
tar_load(tradeSeq_res_panc_DEG_20_CELLS_1000)
# 2,500 cells
tar_load(tradeSeq_res_panc_DEG_01_CELLS_2500)
tar_load(tradeSeq_res_panc_DEG_05_CELLS_2500)
tar_load(tradeSeq_res_panc_DEG_10_CELLS_2500)
tar_load(tradeSeq_res_panc_DEG_20_CELLS_2500)
# 5,000 cells
tar_load(tradeSeq_res_panc_DEG_01_CELLS_5000)
tar_load(tradeSeq_res_panc_DEG_05_CELLS_5000)
tar_load(tradeSeq_res_panc_DEG_10_CELLS_5000)
tar_load(tradeSeq_res_panc_DEG_20_CELLS_5000)
# coerce to list 
tradeSeq_single_subj_panc_list <- purrr::map(ls(pattern = "tradeSeq_res_panc*"), \(x) eval(as.symbol(x)))
names(tradeSeq_single_subj_panc_list) <- ls(pattern = "tradeSeq_res_panc*")
rm(list = ls(pattern = "tradeSeq_res_panc*")); gc(verbose = FALSE, full = TRUE)
```



```{r}
purrr::imap(tradeSeq_single_subj_panc_list, 
            function(x, y) {
  tibble(
    DATASET_NAME = y, 
    MODEL_TYPE = "trdeSeq GAM", 
    PERCENT_DEG = as.numeric(stringr::str_match(y, "_DEG_[0-9]*") %>% stringr::str_remove("_DEG_")) / 100, 
    N_CELLS = as.numeric(stringr::str_match(y, "_CELLS_[0-9]*") %>% stringr::str_remove("_CELLS_")), 
    N_GENES = length(unique(names(x$tradeSeq_results_raw[[1]]))), 
    RUNTIME = as.numeric(x$time_diff[[1]]), 
    RUNTIME_UNITS = attributes(x$time_diff[[1]])$units, 
    MEM_USED = x$mem_usage[[1]][1] / 1000^2,  # convert to megabytes
    MEM_UNITS = "MB", 
    ROC_AUC = yardstick::roc_auc(x$tradeSeq_results_tidy[[1]], 
                                 truth = factor(geneStatus, levels = c("Dynamic", "NotDynamic")), 
                                 .estimate = pvalue_adj, 
                                 event_level = "second") %>% pull(.estimate), 
    ACCURACY = yardstick::accuracy(x$tradeSeq_results_tidy[[1]], 
                                   truth = factor(geneStatus, levels = c("Dynamic", "NotDynamic")), 
                                   estimate = factor(ifelse(gene_dynamic_overall == 1, "Dynamic", "NotDynamic"), 
                                                     levels = c("Dynamic", "NotDynamic"))) %>% 
               pull(.estimate), 
    SENSITIVITY = yardstick::sens(x$tradeSeq_results_tidy[[1]], 
                                  truth = factor(geneStatus, levels = c("Dynamic", "NotDynamic")), 
                                  estimate = factor(ifelse(gene_dynamic_overall == 1, "Dynamic", "NotDynamic"), 
                                                    levels = c("Dynamic", "NotDynamic"))) %>% 
                  pull(.estimate), 
    SPECIFICITY = yardstick::spec(x$tradeSeq_results_tidy[[1]], 
                                  truth = factor(geneStatus, levels = c("Dynamic", "NotDynamic")), 
                                  estimate = factor(ifelse(gene_dynamic_overall == 1, "Dynamic", "NotDynamic"), 
                                                    levels = c("Dynamic", "NotDynamic"))) %>% 
                  pull(.estimate), 
    NIR = mean(x$tradeSeq_results_tidy[[1]]$geneStatus == "NotDynamic"), 
    ROC_CURVE = list(yardstick::roc_curve(x$tradeSeq_results_tidy[[1]], 
                                          truth = factor(geneStatus, levels = c("Dynamic", "NotDynamic")), 
                                          .estimate = pvalue_adj, 
                                          event_level = "second") %>% 
                       mutate(dataset = y))
  )
}) %>% 
  purrr::reduce(rbind) %>% 
  mutate(RUNTIME_HOURS = case_when(RUNTIME_UNITS == "secs" ~ RUNTIME / 60^2, 
                                   RUNTIME_UNITS == "mins" ~ RUNTIME / 60, 
                                   RUNTIME_UNITS == "hours" ~ RUNTIME, 
                                   RUNTIME_UNITS == "days" ~ RUNTIME * 24, 
                                   TRUE ~ NA_real_), 
         .before = 8)  %>% 
  mutate(DATASET_TYPE = "Single subject", .before = 2) -> tradeSeq_single_subj_panc_metrics
```

```{r, echo=FALSE, results='hide'}
rm(scLANE_single_subj_lung_list, scLANE_single_subj_panc_list, tradeSeq_single_subj_lung_list, tradeSeq_single_subj_panc_list); gc(verbose = FALSE, full = TRUE)
```

## Multiple Subjects

### `scLANE` - GEE

#### Lung 



```{r, results='hide'}
# 100 cells
tar_load(scLANE_res_lung_DEG_10_CELLS_100_balanced)
tar_load(scLANE_res_lung_DEG_10_CELLS_100_unbalanced)
tar_load(scLANE_res_lung_DEG_20_CELLS_100_balanced)
tar_load(scLANE_res_lung_DEG_20_CELLS_100_unbalanced)
# 250 cells
tar_load(scLANE_res_lung_DEG_10_CELLS_250_balanced)
tar_load(scLANE_res_lung_DEG_10_CELLS_250_unbalanced)
tar_load(scLANE_res_lung_DEG_20_CELLS_250_balanced)
tar_load(scLANE_res_lung_DEG_20_CELLS_250_unbalanced)
# 1,000 cells
tar_load(scLANE_res_lung_DEG_10_CELLS_1000_balanced)
tar_load(scLANE_res_lung_DEG_10_CELLS_1000_unbalanced)
tar_load(scLANE_res_lung_DEG_20_CELLS_1000_balanced)
tar_load(scLANE_res_lung_DEG_20_CELLS_1000_unbalanced)
# 2,500 cells
tar_load(scLANE_res_lung_DEG_10_CELLS_2500_balanced)
tar_load(scLANE_res_lung_DEG_10_CELLS_2500_unbalanced)
tar_load(scLANE_res_lung_DEG_20_CELLS_2500_balanced)
tar_load(scLANE_res_lung_DEG_20_CELLS_2500_unbalanced)
# 5,000 cells
tar_load(scLANE_res_lung_DEG_10_CELLS_5000_balanced)
tar_load(scLANE_res_lung_DEG_10_CELLS_5000_unbalanced)
tar_load(scLANE_res_lung_DEG_20_CELLS_5000_balanced)
tar_load(scLANE_res_lung_DEG_20_CELLS_5000_unbalanced)
# coerce to list 
scLANE_multi_subj_lung_GEE_list <- purrr::map(ls(pattern = "scLANE_res_lung*"), \(x) eval(as.symbol(x)))
names(scLANE_multi_subj_lung_GEE_list) <- ls(pattern = "scLANE_res_lung*")
rm(list = ls(pattern = "scLANE_res_lung*")); gc(verbose = FALSE, full = TRUE)
```



```{r}
purrr::imap(scLANE_multi_subj_lung_GEE_list, 
            function(x, y) {
  tibble(
    DATASET_NAME = y, 
    MODEL_TYPE = "scLANE GEE", 
    PERCENT_DEG = as.numeric(stringr::str_match(y, "_DEG_[0-9]*") %>% stringr::str_remove("_DEG_")) / 100, 
    N_CELLS = as.numeric(stringr::str_match(y, "_CELLS_[0-9]*") %>% stringr::str_remove("_CELLS_")), 
    N_GENES = length(unique(names(x$testDynamic_results_raw[[1]]))), 
    RUNTIME = as.numeric(x$time_diff[[1]]), 
    RUNTIME_UNITS = attributes(x$time_diff[[1]])$units, 
    MEM_USED = x$mem_usage[[1]][1] / 1000^2,  # convert to megabytes
    MEM_UNITS = "MB", 
    ROC_AUC = yardstick::roc_auc(x$testDynamic_results_tidy[[1]], 
                                 truth = factor(geneStatus_overall, levels = c("Dynamic", "NotDynamic")), 
                                 .estimate = P_Val_Adj, 
                                 event_level = "second") %>% 
              pull(.estimate), 
    ACCURACY = yardstick::accuracy(x$testDynamic_results_tidy[[1]], 
                                   truth = factor(geneStatus_overall, levels = c("Dynamic", "NotDynamic")), 
                                   estimate = factor(ifelse(Gene_Dynamic_Overall == 1, "Dynamic", "NotDynamic"), 
                                                     levels = c("Dynamic", "NotDynamic"))) %>% 
               pull(.estimate), 
    SENSITIVITY = yardstick::sens(x$testDynamic_results_tidy[[1]], 
                                  truth = factor(geneStatus_overall, levels = c("Dynamic", "NotDynamic")), 
                                  estimate = factor(ifelse(Gene_Dynamic_Overall == 1, "Dynamic", "NotDynamic"), 
                                                    levels = c("Dynamic", "NotDynamic"))) %>% 
                  pull(.estimate), 
    SPECIFICITY = yardstick::spec(x$testDynamic_results_tidy[[1]], 
                                  truth = factor(geneStatus_overall, levels = c("Dynamic", "NotDynamic")), 
                                   estimate = factor(ifelse(Gene_Dynamic_Overall == 1, "Dynamic", "NotDynamic"), 
                                                     levels = c("Dynamic", "NotDynamic"))) %>% 
                  pull(.estimate), 
    NIR = mean(x$testDynamic_results_tidy[[1]]$geneStatus == "NotDynamic"), 
    ROC_CURVE = list(yardstick::roc_curve(x$testDynamic_results_tidy[[1]], 
                                          truth = factor(geneStatus_overall, levels = c("Dynamic", "NotDynamic")), 
                                          .estimate = P_Val_Adj, 
                                          event_level = "second") %>% 
                       mutate(dataset = y))
  )
}) %>% 
  purrr::reduce(rbind) %>% 
  mutate(RUNTIME_HOURS = case_when(RUNTIME_UNITS == "seconds" ~ RUNTIME / 60^2, 
                                   RUNTIME_UNITS == "mins" ~ RUNTIME / 60, 
                                   RUNTIME_UNITS == "hours" ~ RUNTIME, 
                                   RUNTIME_UNITS == "days" ~ RUNTIME * 24, 
                                   TRUE ~ NA_real_), 
         .before = 8) %>% 
  mutate(DATASET_TYPE = "Multiple subjects", .before = 2) -> scLANE_multiple_subj_lung_GEE_metrics
```

#### Pancreas 

```{r, results='hide'}
# 100 cells
tar_load(scLANE_res_panc_DEG_10_CELLS_100_balanced)
tar_load(scLANE_res_panc_DEG_10_CELLS_100_unbalanced)
tar_load(scLANE_res_panc_DEG_20_CELLS_100_balanced)
tar_load(scLANE_res_panc_DEG_20_CELLS_100_unbalanced)
# 250 cells
tar_load(scLANE_res_panc_DEG_10_CELLS_250_balanced)
tar_load(scLANE_res_panc_DEG_10_CELLS_250_unbalanced)
tar_load(scLANE_res_panc_DEG_20_CELLS_250_balanced)
tar_load(scLANE_res_panc_DEG_20_CELLS_250_unbalanced)
# 1,000 cells
tar_load(scLANE_res_panc_DEG_10_CELLS_1000_balanced)
tar_load(scLANE_res_panc_DEG_10_CELLS_1000_unbalanced)
tar_load(scLANE_res_panc_DEG_20_CELLS_1000_balanced)
tar_load(scLANE_res_panc_DEG_20_CELLS_1000_unbalanced)
# 2,500 cells
tar_load(scLANE_res_panc_DEG_10_CELLS_2500_balanced)
tar_load(scLANE_res_panc_DEG_10_CELLS_2500_unbalanced)
tar_load(scLANE_res_panc_DEG_20_CELLS_2500_balanced)
tar_load(scLANE_res_panc_DEG_20_CELLS_2500_unbalanced)
# 5,000 cells
tar_load(scLANE_res_panc_DEG_10_CELLS_5000_balanced)
tar_load(scLANE_res_panc_DEG_10_CELLS_5000_unbalanced)
tar_load(scLANE_res_panc_DEG_20_CELLS_5000_balanced)
tar_load(scLANE_res_panc_DEG_20_CELLS_5000_unbalanced)
# coerce to list 
scLANE_multi_subj_panc_GEE_list <- purrr::map(ls(pattern = "scLANE_res_panc*"), \(x) eval(as.symbol(x)))
names(scLANE_multi_subj_panc_GEE_list) <- ls(pattern = "scLANE_res_panc*")
rm(list = ls(pattern = "scLANE_res_panc*")); gc(verbose = FALSE, full = TRUE)
```



```{r}
purrr::imap(scLANE_multi_subj_panc_GEE_list, 
            function(x, y) {
  tibble(
    DATASET_NAME = y, 
    MODEL_TYPE = "scLANE GEE", 
    PERCENT_DEG = as.numeric(stringr::str_match(y, "_DEG_[0-9]*") %>% stringr::str_remove("_DEG_")) / 100, 
    N_CELLS = as.numeric(stringr::str_match(y, "_CELLS_[0-9]*") %>% stringr::str_remove("_CELLS_")), 
    N_GENES = length(unique(names(x$testDynamic_results_raw[[1]]))), 
    RUNTIME = as.numeric(x$time_diff[[1]]), 
    RUNTIME_UNITS = attributes(x$time_diff[[1]])$units, 
    MEM_USED = x$mem_usage[[1]][1] / 1000^2,  # convert to megabytes
    MEM_UNITS = "MB", 
    ROC_AUC = yardstick::roc_auc(x$testDynamic_results_tidy[[1]], 
                                 truth = factor(geneStatus_overall, levels = c("Dynamic", "NotDynamic")), 
                                 .estimate = P_Val_Adj, 
                                 event_level = "second") %>% 
              pull(.estimate), 
    ACCURACY = yardstick::accuracy(x$testDynamic_results_tidy[[1]], 
                                   truth = factor(geneStatus_overall, levels = c("Dynamic", "NotDynamic")), 
                                   estimate = factor(ifelse(Gene_Dynamic_Overall == 1, "Dynamic", "NotDynamic"), 
                                                     levels = c("Dynamic", "NotDynamic"))) %>% 
               pull(.estimate), 
    SENSITIVITY = yardstick::sens(x$testDynamic_results_tidy[[1]], 
                                  truth = factor(geneStatus_overall, levels = c("Dynamic", "NotDynamic")), 
                                  estimate = factor(ifelse(Gene_Dynamic_Overall == 1, "Dynamic", "NotDynamic"), 
                                                    levels = c("Dynamic", "NotDynamic"))) %>% 
                  pull(.estimate), 
    SPECIFICITY = yardstick::spec(x$testDynamic_results_tidy[[1]], 
                                  truth = factor(geneStatus_overall, levels = c("Dynamic", "NotDynamic")), 
                                   estimate = factor(ifelse(Gene_Dynamic_Overall == 1, "Dynamic", "NotDynamic"), 
                                                     levels = c("Dynamic", "NotDynamic"))) %>% 
                  pull(.estimate), 
    NIR = mean(x$testDynamic_results_tidy[[1]]$geneStatus == "NotDynamic"), 
    ROC_CURVE = list(yardstick::roc_curve(x$testDynamic_results_tidy[[1]], 
                                          truth = factor(geneStatus_overall, levels = c("Dynamic", "NotDynamic")), 
                                          .estimate = P_Val_Adj, 
                                          event_level = "second") %>% 
                       mutate(dataset = y))
  )
}) %>% 
  purrr::reduce(rbind) %>% 
  mutate(RUNTIME_HOURS = case_when(RUNTIME_UNITS == "seconds" ~ RUNTIME / 60^2, 
                                   RUNTIME_UNITS == "mins" ~ RUNTIME / 60, 
                                   RUNTIME_UNITS == "hours" ~ RUNTIME, 
                                   RUNTIME_UNITS == "days" ~ RUNTIME * 24, 
                                   TRUE ~ NA_real_), 
         .before = 8) %>% 
  mutate(DATASET_TYPE = "Multiple subjects", .before = 2) -> scLANE_multiple_subj_panc_GEE_metrics
```

### `scLANE` - Evenly-spaced GLMM

#### Lung 

```{r, results='hide'}
# 100 cell
tar_load(scLANE_res_lung_DEG_10_CELLS_100_balanced_GLMM_even)
tar_load(scLANE_res_lung_DEG_10_CELLS_100_unbalanced_GLMM_even)
tar_load(scLANE_res_lung_DEG_20_CELLS_100_balanced_GLMM_even)
tar_load(scLANE_res_lung_DEG_20_CELLS_100_unbalanced_GLMM_even)
# 250 cells
tar_load(scLANE_res_lung_DEG_10_CELLS_250_balanced_GLMM_even)
tar_load(scLANE_res_lung_DEG_10_CELLS_250_unbalanced_GLMM_even)
tar_load(scLANE_res_lung_DEG_20_CELLS_250_balanced_GLMM_even)
tar_load(scLANE_res_lung_DEG_20_CELLS_250_unbalanced_GLMM_even)
# 1,000 cells
tar_load(scLANE_res_lung_DEG_10_CELLS_1000_balanced_GLMM_even)
tar_load(scLANE_res_lung_DEG_10_CELLS_1000_unbalanced_GLMM_even)
tar_load(scLANE_res_lung_DEG_20_CELLS_1000_balanced_GLMM_even)
tar_load(scLANE_res_lung_DEG_20_CELLS_1000_unbalanced_GLMM_even)
# 2,500 cells
tar_load(scLANE_res_lung_DEG_10_CELLS_2500_balanced_GLMM_even)
tar_load(scLANE_res_lung_DEG_10_CELLS_2500_unbalanced_GLMM_even)
tar_load(scLANE_res_lung_DEG_20_CELLS_2500_balanced_GLMM_even)
tar_load(scLANE_res_lung_DEG_20_CELLS_2500_unbalanced_GLMM_even)
# 5,000 cells
tar_load(scLANE_res_lung_DEG_10_CELLS_5000_balanced_GLMM_even)
tar_load(scLANE_res_lung_DEG_10_CELLS_5000_unbalanced_GLMM_even)
tar_load(scLANE_res_lung_DEG_20_CELLS_5000_balanced_GLMM_even)
tar_load(scLANE_res_lung_DEG_20_CELLS_5000_unbalanced_GLMM_even)
# coerce to list 
scLANE_multi_subj_lung_even_GLMM_list <- purrr::map(ls(pattern = "scLANE_res_lung*"), \(x) eval(as.symbol(x)))
names(scLANE_multi_subj_lung_even_GLMM_list) <- ls(pattern = "scLANE_res_lung*")
rm(list = ls(pattern = "scLANE_res_lung*")); gc(verbose = FALSE, full = TRUE)
```



```{r}
purrr::imap(scLANE_multi_subj_lung_even_GLMM_list, 
            function(x, y) {
  tibble(
    DATASET_NAME = y, 
    MODEL_TYPE = "scLANE Evenly-spaced GLMM", 
    PERCENT_DEG = as.numeric(stringr::str_match(y, "_DEG_[0-9]*") %>% stringr::str_remove("_DEG_")) / 100, 
    N_CELLS = as.numeric(stringr::str_match(y, "_CELLS_[0-9]*") %>% stringr::str_remove("_CELLS_")), 
    N_GENES = length(unique(names(x$testDynamic_results_raw[[1]]))), 
    RUNTIME = as.numeric(x$time_diff[[1]]), 
    RUNTIME_UNITS = attributes(x$time_diff[[1]])$units, 
    MEM_USED = x$mem_usage[[1]][1] / 1000^2,  # convert to megabytes
    MEM_UNITS = "MB", 
    ROC_AUC = yardstick::roc_auc(x$testDynamic_results_tidy[[1]], 
                                 truth = factor(geneStatus_overall, levels = c("Dynamic", "NotDynamic")), 
                                 .estimate = P_Val_Adj, 
                                 event_level = "second") %>% 
              pull(.estimate), 
    ACCURACY = yardstick::accuracy(x$testDynamic_results_tidy[[1]], 
                                   truth = factor(geneStatus_overall, levels = c("Dynamic", "NotDynamic")), 
                                   estimate = factor(ifelse(Gene_Dynamic_Overall == 1, "Dynamic", "NotDynamic"), 
                                                     levels = c("Dynamic", "NotDynamic"))) %>% 
               pull(.estimate), 
    SENSITIVITY = yardstick::sens(x$testDynamic_results_tidy[[1]], 
                                  truth = factor(geneStatus_overall, levels = c("Dynamic", "NotDynamic")), 
                                  estimate = factor(ifelse(Gene_Dynamic_Overall == 1, "Dynamic", "NotDynamic"), 
                                                    levels = c("Dynamic", "NotDynamic"))) %>% 
                  pull(.estimate), 
    SPECIFICITY = yardstick::spec(x$testDynamic_results_tidy[[1]], 
                                  truth = factor(geneStatus_overall, levels = c("Dynamic", "NotDynamic")), 
                                   estimate = factor(ifelse(Gene_Dynamic_Overall == 1, "Dynamic", "NotDynamic"), 
                                                     levels = c("Dynamic", "NotDynamic"))) %>% 
                  pull(.estimate), 
    NIR = mean(x$testDynamic_results_tidy[[1]]$geneStatus == "NotDynamic"), 
    ROC_CURVE = list(yardstick::roc_curve(x$testDynamic_results_tidy[[1]], 
                                          truth = factor(geneStatus_overall, levels = c("Dynamic", "NotDynamic")), 
                                          .estimate = P_Val_Adj, 
                                          event_level = "second") %>% 
                       mutate(dataset = y))
  )
}) %>% 
  purrr::reduce(rbind) %>% 
  mutate(RUNTIME_HOURS = case_when(RUNTIME_UNITS == "seconds" ~ RUNTIME / 60^2, 
                                   RUNTIME_UNITS == "mins" ~ RUNTIME / 60, 
                                   RUNTIME_UNITS == "hours" ~ RUNTIME, 
                                   RUNTIME_UNITS == "days" ~ RUNTIME * 24, 
                                   TRUE ~ NA_real_), 
         .before = 8) %>% 
  mutate(DATASET_TYPE = "Multiple subjects", .before = 2) -> scLANE_multiple_subj_lung_even_GLMM_metrics
```

#### Pancreas 

```{r, results='hide'}
# 100 cell
tar_load(scLANE_res_panc_DEG_10_CELLS_100_balanced_GLMM_even)
tar_load(scLANE_res_panc_DEG_10_CELLS_100_unbalanced_GLMM_even)
tar_load(scLANE_res_panc_DEG_20_CELLS_100_balanced_GLMM_even)
tar_load(scLANE_res_panc_DEG_20_CELLS_100_unbalanced_GLMM_even)
# 250 cells
tar_load(scLANE_res_panc_DEG_10_CELLS_250_balanced_GLMM_even)
tar_load(scLANE_res_panc_DEG_10_CELLS_250_unbalanced_GLMM_even)
tar_load(scLANE_res_panc_DEG_20_CELLS_250_balanced_GLMM_even)
tar_load(scLANE_res_panc_DEG_20_CELLS_250_unbalanced_GLMM_even)
# 1,000 cells
tar_load(scLANE_res_panc_DEG_10_CELLS_1000_balanced_GLMM_even)
tar_load(scLANE_res_panc_DEG_10_CELLS_1000_unbalanced_GLMM_even)
tar_load(scLANE_res_panc_DEG_20_CELLS_1000_balanced_GLMM_even)
tar_load(scLANE_res_panc_DEG_20_CELLS_1000_unbalanced_GLMM_even)
# 2,500 cells
tar_load(scLANE_res_panc_DEG_10_CELLS_2500_balanced_GLMM_even)
tar_load(scLANE_res_panc_DEG_10_CELLS_2500_unbalanced_GLMM_even)
tar_load(scLANE_res_panc_DEG_20_CELLS_2500_balanced_GLMM_even)
tar_load(scLANE_res_panc_DEG_20_CELLS_2500_unbalanced_GLMM_even)
# 5,000 cells
tar_load(scLANE_res_panc_DEG_10_CELLS_5000_balanced_GLMM_even)
tar_load(scLANE_res_panc_DEG_10_CELLS_5000_unbalanced_GLMM_even)
tar_load(scLANE_res_panc_DEG_20_CELLS_5000_balanced_GLMM_even)
tar_load(scLANE_res_panc_DEG_20_CELLS_5000_unbalanced_GLMM_even)
# coerce to list 
scLANE_multi_subj_panc_even_GLMM_list <- purrr::map(ls(pattern = "scLANE_res_panc*"), \(x) eval(as.symbol(x)))
names(scLANE_multi_subj_panc_even_GLMM_list) <- ls(pattern = "scLANE_res_panc*")
rm(list = ls(pattern = "scLANE_res_panc*")); gc(verbose = FALSE, full = TRUE)
```



```{r}
purrr::imap(scLANE_multi_subj_panc_even_GLMM_list, 
            function(x, y) {
  tibble(
    DATASET_NAME = y, 
    MODEL_TYPE = "scLANE Evenly-spaced GLMM", 
    PERCENT_DEG = as.numeric(stringr::str_match(y, "_DEG_[0-9]*") %>% stringr::str_remove("_DEG_")) / 100, 
    N_CELLS = as.numeric(stringr::str_match(y, "_CELLS_[0-9]*") %>% stringr::str_remove("_CELLS_")), 
    N_GENES = length(unique(names(x$testDynamic_results_raw[[1]]))), 
    RUNTIME = as.numeric(x$time_diff[[1]]), 
    RUNTIME_UNITS = attributes(x$time_diff[[1]])$units, 
    MEM_USED = x$mem_usage[[1]][1] / 1000^2,  # convert to megabytes
    MEM_UNITS = "MB", 
    ROC_AUC = yardstick::roc_auc(x$testDynamic_results_tidy[[1]], 
                                 truth = factor(geneStatus_overall, levels = c("Dynamic", "NotDynamic")), 
                                 .estimate = P_Val_Adj, 
                                 event_level = "second") %>% 
              pull(.estimate), 
    ACCURACY = yardstick::accuracy(x$testDynamic_results_tidy[[1]], 
                                   truth = factor(geneStatus_overall, levels = c("Dynamic", "NotDynamic")), 
                                   estimate = factor(ifelse(Gene_Dynamic_Overall == 1, "Dynamic", "NotDynamic"), 
                                                     levels = c("Dynamic", "NotDynamic"))) %>% 
               pull(.estimate), 
    SENSITIVITY = yardstick::sens(x$testDynamic_results_tidy[[1]], 
                                  truth = factor(geneStatus_overall, levels = c("Dynamic", "NotDynamic")), 
                                  estimate = factor(ifelse(Gene_Dynamic_Overall == 1, "Dynamic", "NotDynamic"), 
                                                    levels = c("Dynamic", "NotDynamic"))) %>% 
                  pull(.estimate), 
    SPECIFICITY = yardstick::spec(x$testDynamic_results_tidy[[1]], 
                                  truth = factor(geneStatus_overall, levels = c("Dynamic", "NotDynamic")), 
                                   estimate = factor(ifelse(Gene_Dynamic_Overall == 1, "Dynamic", "NotDynamic"), 
                                                     levels = c("Dynamic", "NotDynamic"))) %>% 
                  pull(.estimate), 
    NIR = mean(x$testDynamic_results_tidy[[1]]$geneStatus == "NotDynamic"), 
    ROC_CURVE = list(yardstick::roc_curve(x$testDynamic_results_tidy[[1]], 
                                          truth = factor(geneStatus_overall, levels = c("Dynamic", "NotDynamic")), 
                                          .estimate = P_Val_Adj, 
                                          event_level = "second") %>% 
                       mutate(dataset = y))
  )
}) %>% 
  purrr::reduce(rbind) %>% 
  mutate(RUNTIME_HOURS = case_when(RUNTIME_UNITS == "seconds" ~ RUNTIME / 60^2, 
                                   RUNTIME_UNITS == "mins" ~ RUNTIME / 60, 
                                   RUNTIME_UNITS == "hours" ~ RUNTIME, 
                                   RUNTIME_UNITS == "days" ~ RUNTIME * 24, 
                                   TRUE ~ NA_real_), 
         .before = 8) %>% 
  mutate(DATASET_TYPE = "Multiple subjects", .before = 2) -> scLANE_multiple_subj_panc_even_GLMM_metrics
```

### `scLANE` - Adaptive GLMM

#### Lung 

```{r, results='hide'}
# 100 cell
tar_load(scLANE_res_lung_DEG_10_CELLS_100_balanced_GLMM_adaptive)
tar_load(scLANE_res_lung_DEG_10_CELLS_100_unbalanced_GLMM_adaptive)
tar_load(scLANE_res_lung_DEG_20_CELLS_100_balanced_GLMM_adaptive)
tar_load(scLANE_res_lung_DEG_20_CELLS_100_unbalanced_GLMM_adaptive)
# 250 cells
tar_load(scLANE_res_lung_DEG_10_CELLS_250_balanced_GLMM_adaptive)
tar_load(scLANE_res_lung_DEG_10_CELLS_250_unbalanced_GLMM_adaptive)
tar_load(scLANE_res_lung_DEG_20_CELLS_250_balanced_GLMM_adaptive)
tar_load(scLANE_res_lung_DEG_20_CELLS_250_unbalanced_GLMM_adaptive)
# 1,000 cells
tar_load(scLANE_res_lung_DEG_10_CELLS_1000_balanced_GLMM_adaptive)
tar_load(scLANE_res_lung_DEG_10_CELLS_1000_unbalanced_GLMM_adaptive)
tar_load(scLANE_res_lung_DEG_20_CELLS_1000_balanced_GLMM_adaptive)
tar_load(scLANE_res_lung_DEG_20_CELLS_1000_unbalanced_GLMM_adaptive)
# 2,500 cells
tar_load(scLANE_res_lung_DEG_10_CELLS_2500_balanced_GLMM_adaptive)
tar_load(scLANE_res_lung_DEG_10_CELLS_2500_unbalanced_GLMM_adaptive)
tar_load(scLANE_res_lung_DEG_20_CELLS_2500_balanced_GLMM_adaptive)
tar_load(scLANE_res_lung_DEG_20_CELLS_2500_unbalanced_GLMM_adaptive)
# 5,000 cells
tar_load(scLANE_res_lung_DEG_10_CELLS_5000_balanced_GLMM_adaptive)
tar_load(scLANE_res_lung_DEG_10_CELLS_5000_unbalanced_GLMM_adaptive)
tar_load(scLANE_res_lung_DEG_20_CELLS_5000_balanced_GLMM_adaptive)
tar_load(scLANE_res_lung_DEG_20_CELLS_5000_unbalanced_GLMM_adaptive)
# coerce to list 
scLANE_multi_subj_lung_adaptive_GLMM_list <- purrr::map(ls(pattern = "scLANE_res_lung*"), \(x) eval(as.symbol(x)))
names(scLANE_multi_subj_lung_adaptive_GLMM_list) <- ls(pattern = "scLANE_res_lung*")
rm(list = ls(pattern = "scLANE_res_lung*")); gc(verbose = FALSE, full = TRUE)
```



```{r}
purrr::imap(scLANE_multi_subj_lung_adaptive_GLMM_list, 
            function(x, y) {
  tibble(
    DATASET_NAME = y, 
    MODEL_TYPE = "scLANE Adaptive GLMM", 
    PERCENT_DEG = as.numeric(stringr::str_match(y, "_DEG_[0-9]*") %>% stringr::str_remove("_DEG_")) / 100, 
    N_CELLS = as.numeric(stringr::str_match(y, "_CELLS_[0-9]*") %>% stringr::str_remove("_CELLS_")), 
    N_GENES = length(unique(names(x$testDynamic_results_raw[[1]]))), 
    RUNTIME = as.numeric(x$time_diff[[1]]), 
    RUNTIME_UNITS = attributes(x$time_diff[[1]])$units, 
    MEM_USED = x$mem_usage[[1]][1] / 1000^2,  # convert to megabytes
    MEM_UNITS = "MB", 
    ROC_AUC = yardstick::roc_auc(x$testDynamic_results_tidy[[1]], 
                                 truth = factor(geneStatus_overall, levels = c("Dynamic", "NotDynamic")), 
                                 .estimate = P_Val_Adj, 
                                 event_level = "second") %>% 
              pull(.estimate), 
    ACCURACY = yardstick::accuracy(x$testDynamic_results_tidy[[1]], 
                                   truth = factor(geneStatus_overall, levels = c("Dynamic", "NotDynamic")), 
                                   estimate = factor(ifelse(Gene_Dynamic_Overall == 1, "Dynamic", "NotDynamic"), 
                                                     levels = c("Dynamic", "NotDynamic"))) %>% 
               pull(.estimate), 
    SENSITIVITY = yardstick::sens(x$testDynamic_results_tidy[[1]], 
                                  truth = factor(geneStatus_overall, levels = c("Dynamic", "NotDynamic")), 
                                  estimate = factor(ifelse(Gene_Dynamic_Overall == 1, "Dynamic", "NotDynamic"), 
                                                    levels = c("Dynamic", "NotDynamic"))) %>% 
                  pull(.estimate), 
    SPECIFICITY = yardstick::spec(x$testDynamic_results_tidy[[1]], 
                                  truth = factor(geneStatus_overall, levels = c("Dynamic", "NotDynamic")), 
                                   estimate = factor(ifelse(Gene_Dynamic_Overall == 1, "Dynamic", "NotDynamic"), 
                                                     levels = c("Dynamic", "NotDynamic"))) %>% 
                  pull(.estimate), 
    NIR = mean(x$testDynamic_results_tidy[[1]]$geneStatus == "NotDynamic"), 
    ROC_CURVE = list(yardstick::roc_curve(x$testDynamic_results_tidy[[1]], 
                                          truth = factor(geneStatus_overall, levels = c("Dynamic", "NotDynamic")), 
                                          .estimate = P_Val_Adj, 
                                          event_level = "second") %>% 
                       mutate(dataset = y))
  )
}) %>% 
  purrr::reduce(rbind) %>% 
  mutate(RUNTIME_HOURS = case_when(RUNTIME_UNITS == "seconds" ~ RUNTIME / 60^2, 
                                   RUNTIME_UNITS == "mins" ~ RUNTIME / 60, 
                                   RUNTIME_UNITS == "hours" ~ RUNTIME, 
                                   RUNTIME_UNITS == "days" ~ RUNTIME * 24, 
                                   TRUE ~ NA_real_), 
         .before = 8) %>% 
  mutate(DATASET_TYPE = "Multiple subjects", .before = 2) -> scLANE_multiple_subj_lung_adaptive_GLMM_metrics
```

#### Pancreas 

```{r, results='hide'}
# 100 cell
tar_load(scLANE_res_panc_DEG_10_CELLS_100_balanced_GLMM_adaptive)
tar_load(scLANE_res_panc_DEG_10_CELLS_100_unbalanced_GLMM_adaptive)
tar_load(scLANE_res_panc_DEG_20_CELLS_100_balanced_GLMM_adaptive)
tar_load(scLANE_res_panc_DEG_20_CELLS_100_unbalanced_GLMM_adaptive)
# 250 cells
tar_load(scLANE_res_panc_DEG_10_CELLS_250_balanced_GLMM_adaptive)
tar_load(scLANE_res_panc_DEG_10_CELLS_250_unbalanced_GLMM_adaptive)
tar_load(scLANE_res_panc_DEG_20_CELLS_250_balanced_GLMM_adaptive)
tar_load(scLANE_res_panc_DEG_20_CELLS_250_unbalanced_GLMM_adaptive)
# 1,000 cells
tar_load(scLANE_res_panc_DEG_10_CELLS_1000_balanced_GLMM_adaptive)
tar_load(scLANE_res_panc_DEG_10_CELLS_1000_unbalanced_GLMM_adaptive)
tar_load(scLANE_res_panc_DEG_20_CELLS_1000_balanced_GLMM_adaptive)
tar_load(scLANE_res_panc_DEG_20_CELLS_1000_unbalanced_GLMM_adaptive)
# 2,500 cells
tar_load(scLANE_res_panc_DEG_10_CELLS_2500_balanced_GLMM_adaptive)
tar_load(scLANE_res_panc_DEG_10_CELLS_2500_unbalanced_GLMM_adaptive)
tar_load(scLANE_res_panc_DEG_20_CELLS_2500_balanced_GLMM_adaptive)
tar_load(scLANE_res_panc_DEG_20_CELLS_2500_unbalanced_GLMM_adaptive)
# 5,000 cells
tar_load(scLANE_res_panc_DEG_10_CELLS_5000_balanced_GLMM_adaptive)
tar_load(scLANE_res_panc_DEG_10_CELLS_5000_unbalanced_GLMM_adaptive)
tar_load(scLANE_res_panc_DEG_20_CELLS_5000_balanced_GLMM_adaptive)
tar_load(scLANE_res_panc_DEG_20_CELLS_5000_unbalanced_GLMM_adaptive)
# coerce to list 
scLANE_multi_subj_panc_adaptive_GLMM_list <- purrr::map(ls(pattern = "scLANE_res_panc*"), \(x) eval(as.symbol(x)))
names(scLANE_multi_subj_panc_adaptive_GLMM_list) <- ls(pattern = "scLANE_res_panc*")
rm(list = ls(pattern = "scLANE_res_panc*")); gc(verbose = FALSE, full = TRUE)
```



```{r}
purrr::imap(scLANE_multi_subj_panc_adaptive_GLMM_list, 
            function(x, y) {
  tibble(
    DATASET_NAME = y, 
    MODEL_TYPE = "scLANE Adaptive GLMM", 
    PERCENT_DEG = as.numeric(stringr::str_match(y, "_DEG_[0-9]*") %>% stringr::str_remove("_DEG_")) / 100, 
    N_CELLS = as.numeric(stringr::str_match(y, "_CELLS_[0-9]*") %>% stringr::str_remove("_CELLS_")), 
    N_GENES = length(unique(names(x$testDynamic_results_raw[[1]]))), 
    RUNTIME = as.numeric(x$time_diff[[1]]), 
    RUNTIME_UNITS = attributes(x$time_diff[[1]])$units, 
    MEM_USED = x$mem_usage[[1]][1] / 1000^2,  # convert to megabytes
    MEM_UNITS = "MB", 
    ROC_AUC = yardstick::roc_auc(x$testDynamic_results_tidy[[1]], 
                                 truth = factor(geneStatus_overall, levels = c("Dynamic", "NotDynamic")), 
                                 .estimate = P_Val_Adj, 
                                 event_level = "second") %>% 
              pull(.estimate), 
    ACCURACY = yardstick::accuracy(x$testDynamic_results_tidy[[1]], 
                                   truth = factor(geneStatus_overall, levels = c("Dynamic", "NotDynamic")), 
                                   estimate = factor(ifelse(Gene_Dynamic_Overall == 1, "Dynamic", "NotDynamic"), 
                                                     levels = c("Dynamic", "NotDynamic"))) %>% 
               pull(.estimate), 
    SENSITIVITY = yardstick::sens(x$testDynamic_results_tidy[[1]], 
                                  truth = factor(geneStatus_overall, levels = c("Dynamic", "NotDynamic")), 
                                  estimate = factor(ifelse(Gene_Dynamic_Overall == 1, "Dynamic", "NotDynamic"), 
                                                    levels = c("Dynamic", "NotDynamic"))) %>% 
                  pull(.estimate), 
    SPECIFICITY = yardstick::spec(x$testDynamic_results_tidy[[1]], 
                                  truth = factor(geneStatus_overall, levels = c("Dynamic", "NotDynamic")), 
                                   estimate = factor(ifelse(Gene_Dynamic_Overall == 1, "Dynamic", "NotDynamic"), 
                                                     levels = c("Dynamic", "NotDynamic"))) %>% 
                  pull(.estimate), 
    NIR = mean(x$testDynamic_results_tidy[[1]]$geneStatus == "NotDynamic"), 
    ROC_CURVE = list(yardstick::roc_curve(x$testDynamic_results_tidy[[1]], 
                                          truth = factor(geneStatus_overall, levels = c("Dynamic", "NotDynamic")), 
                                          .estimate = P_Val_Adj, 
                                          event_level = "second") %>% 
                       mutate(dataset = y))
  )
}) %>% 
  purrr::reduce(rbind) %>% 
  mutate(RUNTIME_HOURS = case_when(RUNTIME_UNITS == "seconds" ~ RUNTIME / 60^2, 
                                   RUNTIME_UNITS == "mins" ~ RUNTIME / 60, 
                                   RUNTIME_UNITS == "hours" ~ RUNTIME, 
                                   RUNTIME_UNITS == "days" ~ RUNTIME * 24, 
                                   TRUE ~ NA_real_), 
         .before = 8) %>% 
  mutate(DATASET_TYPE = "Multiple subjects", .before = 2) -> scLANE_multiple_subj_panc_adaptive_GLMM_metrics
```

### `tradeSeq`

#### Lung



```{r, results='hide'}
# 100 cells
tar_load(tradeSeq_res_DEG_10_CELLS_100_balanced)
tar_load(tradeSeq_res_DEG_10_CELLS_100_unbalanced)
tar_load(tradeSeq_res_DEG_20_CELLS_100_balanced)
tar_load(tradeSeq_res_DEG_20_CELLS_100_unbalanced)
# 250 cells
tar_load(tradeSeq_res_DEG_10_CELLS_250_balanced)
tar_load(tradeSeq_res_DEG_10_CELLS_250_unbalanced)
tar_load(tradeSeq_res_DEG_20_CELLS_250_balanced)
tar_load(tradeSeq_res_DEG_20_CELLS_250_unbalanced)
# 1,000 cells
tar_load(tradeSeq_res_DEG_10_CELLS_1000_balanced)
tar_load(tradeSeq_res_DEG_10_CELLS_1000_unbalanced)
tar_load(tradeSeq_res_DEG_20_CELLS_1000_balanced)
tar_load(tradeSeq_res_DEG_20_CELLS_1000_unbalanced)
# 2,500 cells
tar_load(tradeSeq_res_DEG_10_CELLS_2500_balanced)
tar_load(tradeSeq_res_DEG_10_CELLS_2500_unbalanced)
tar_load(tradeSeq_res_DEG_20_CELLS_2500_balanced)
tar_load(tradeSeq_res_DEG_20_CELLS_2500_unbalanced)
# 5,000 cells
tar_load(tradeSeq_res_DEG_10_CELLS_5000_balanced)
tar_load(tradeSeq_res_DEG_10_CELLS_5000_unbalanced)
tar_load(tradeSeq_res_DEG_20_CELLS_5000_balanced)
tar_load(tradeSeq_res_DEG_20_CELLS_5000_unbalanced)
# coerce to list 
tradeSeq_multi_subj_list <- purrr::map(ls(pattern = "tradeSeq_res*"), function(x) { eval(as.symbol(x)) })
names(tradeSeq_multi_subj_list) <- ls(pattern = "tradeSeq_res*")
rm(list = ls(pattern = "tradeSeq_res*")); gc(verbose = FALSE, full = TRUE)
```

```{r}
purrr::map2(tradeSeq_multi_subj_list, 
            names(tradeSeq_multi_subj_list), 
            function(x, y) {
  tibble(
    DATASET_NAME = y, 
    MODEL_TYPE = "tradeSeq GAM", 
    PERCENT_DEG = as.numeric(stringr::str_match(y, "_DEG_[0-9]*") %>% stringr::str_remove("_DEG_")) / 100, 
    N_CELLS = as.numeric(stringr::str_match(y, "_CELLS_[0-9]*") %>% stringr::str_remove("_CELLS_")), 
    N_GENES = length(unique(names(x$tradeSeq_results_raw[[1]]))), 
    RUNTIME = as.numeric(x$time_diff[[1]]), 
    RUNTIME_UNITS = attributes(x$time_diff[[1]])$units, 
    MEM_USED = x$mem_usage[[1]][1] / 1000^2,  # convert to megabytes
    MEM_UNITS = "MB", 
    ROC_AUC = yardstick::roc_auc(x$tradeSeq_results_tidy[[1]], 
                                 truth = as.factor(geneStatus), 
                                 .estimate = pvalue_adj, 
                                 event_level = "second") %>% pull(.estimate), 
    ACCURACY = yardstick::accuracy(x$tradeSeq_results_tidy[[1]], 
                                   truth = as.factor(geneStatus), 
                                   estimate = factor(ifelse(gene_dynamic_overall == 1, "Dynamic", "NotDynamic"), 
                                                     levels = c("Dynamic", "NotDynamic"))) %>% 
               pull(.estimate), 
    SENSITIVITY = yardstick::sens(x$tradeSeq_results_tidy[[1]], 
                                  truth = as.factor(geneStatus), 
                                   estimate = factor(ifelse(gene_dynamic_overall == 1, "Dynamic", "NotDynamic"), 
                                                     levels = c("Dynamic", "NotDynamic"))) %>% 
                  pull(.estimate), 
    SPECIFICITY = yardstick::spec(x$tradeSeq_results_tidy[[1]], 
                                  truth = as.factor(geneStatus), 
                                   estimate = factor(ifelse(gene_dynamic_overall == 1, "Dynamic", "NotDynamic"), 
                                                     levels = c("Dynamic", "NotDynamic"))) %>% 
                  pull(.estimate), 
    NIR = mean(x$tradeSeq_results_tidy[[1]]$geneStatus == "NotDynamic"), 
    ROC_CURVE = list(yardstick::roc_curve(x$tradeSeq_results_tidy[[1]], 
                                          truth = as.factor(geneStatus), 
                                          .estimate = pvalue_adj, 
                                          event_level = "second"))
  )
}) %>% 
  purrr::reduce(rbind) %>% 
  mutate(RUNTIME_HOURS = case_when(RUNTIME_UNITS == "seconds" ~ RUNTIME / 60^2, 
                                   RUNTIME_UNITS == "mins" ~ RUNTIME / 60, 
                                   RUNTIME_UNITS == "hours" ~ RUNTIME, 
                                   RUNTIME_UNITS == "days" ~ RUNTIME * 24, 
                                   TRUE ~ NA_real_), 
         .before = 7)  %>% 
  mutate(DATASET_TYPE = "Multiple subjects", .before = 2) -> tradeSeq_multi_subj_metrics
```

#### Pancreas 

```{r}

```


```{r}

```


```{r, echo=FALSE, results='hide'}
rm(scLANE_multi_subj_lung_list, scLANE_multi_subj_panc_list, tradeSeq_multi_subj_lung_list, tradeSeq_multi_subj_panc_list); gc(verbose = FALSE, full = TRUE)
```

```{r}
metric_table <- purrr::map_dfr(ls(pattern = "*_metrics"), \(x) eval(as.symbol(x)))
saveRDS(metric_table, file = "./results/data/Simulation_Performance_Metrics.Rds")
```

# Plot-Saving Function

This function will help us save our `ggplot2` objects as PDFs in the correct directories. 

```{r}
save_plot <- function(p.obj = NULL, 
                      p.name = NULL,
                      data.type = "single", 
                      p.dims = c("8", "5"), 
                      ...) {
  # check inputs 
  if (is.null(p.obj)) { stop("ggplot2 object must not be null.") }
  if (is.null(p.name)) { stop("Plot name must not be null.") }
  data.type <- tolower(data.type)
  
  # save plot
  if (data.type == "single") {
    ppath <- "./results/plots/SingleSubject/"
  } else {
    ppath <- "./results/plots/MultiSubject/"
  }
  ggplot2::ggsave(path = ppath, 
                  filename = p.name, 
                  plot = p, 
                  device = "pdf", 
                  width = p.dims[1], 
                  height = p.dims[2], 
                  ...)
}
```

# Single Subject Plots

```{r}
if (!dir.exists("./results/plots")) {
  dir.create("./results/plots")
}
if (!dir.exists("./results/plots/SingleSubject")) {
  dir.create("./results/plots/SingleSubject")
}
```

## Compute Time

### By $N_{cells}$

#### `scLANE`

```{r}
p1 <- metric_table %>% 
      filter(grepl("scLANE_", DATASET_NAME), 
             DATASET_TYPE == "Single subject") %>% 
      ggplot(aes(x = N_CELLS, y = RUNTIME_HOURS)) + 
      geom_point() + 
      geom_smooth(method = "lm") + 
      scale_x_continuous(labels = scales::comma_format()) + 
      labs(x = "Number of Cells", 
           y = "Runtime (Hours)", 
           title = "scLANE Computational Cost") + 
      theme_classic(base_size = 14)
p1
```

#### `tradeSeq`

```{r}
p2 <- metric_table %>% 
      filter(grepl("tradeSeq_", DATASET_NAME), 
             DATASET_TYPE == "Single subject") %>% 
      ggplot(aes(x = N_CELLS, y = RUNTIME_HOURS)) + 
      geom_point() + 
      geom_smooth(method = "lm") + 
      scale_x_continuous(labels = scales::comma_format()) + 
      labs(x = "Number of Cells", 
           y = "Runtime (Hours)", 
           title = "tradeSeq Computational Cost") + 
      theme_classic(base_size = 14)
p2
```

### By $N_{genes}$

#### `scLANE`

```{r}
p3 <- metric_table %>% 
      filter(grepl("scLANE_", DATASET_NAME), 
             DATASET_TYPE == "Single subject") %>% 
      ggplot(aes(x = N_GENES, y = RUNTIME_HOURS)) + 
      # facet_wrap(~N_CELLS) + 
      geom_point() + 
      geom_smooth(method = "lm") + 
      scale_x_continuous(labels = scales::comma_format()) + 
      labs(x = "Number of Genes", 
           y = "Runtime (Hours)", 
           title = "scLANE Computational Cost") + 
      theme_classic(base_size = 14) 
p3
```

#### `tradeSeq`

```{r}
p3 <- metric_table %>% 
      filter(grepl("tradeSeq_", DATASET_NAME), 
             DATASET_TYPE == "Single subject") %>% 
      ggplot(aes(x = N_GENES, y = RUNTIME_HOURS)) + 
      # facet_wrap(~N_CELLS) + 
      geom_point() + 
      geom_smooth(method = "lm") + 
      scale_x_continuous(labels = scales::comma_format()) + 
      labs(x = "Number of Genes", 
           y = "Runtime (Hours)", 
           title = "tradeSeq Computational Cost") + 
      theme_classic(base_size = 14) 
p3
```

### By $P_{DE}$

#### `scLANE`

```{r}
p5 <- metric_table %>% 
      filter(grepl("scLANE_", DATASET_NAME), 
             DATASET_TYPE == "Single subject") %>% 
      ggplot(aes(x = PERCENT_DEG, y = RUNTIME_HOURS)) + 
      # facet_wrap(~N_CELLS) + 
      geom_point() + 
      geom_smooth(method = "lm") + 
      scale_x_continuous(labels = scales::percent_format()) + 
      labs(x = "% Dynamic Genes", 
           y = "Runtime (Hours)", 
           title = "scLANE Computational Cost") + 
      theme_classic(base_size = 14) 
p5
```

#### `tradeSeq`

```{r}
p6 <- metric_table %>% 
      filter(grepl("tradeSeq_", DATASET_NAME), 
             DATASET_TYPE == "Single subject") %>% 
      ggplot(aes(x = PERCENT_DEG, y = RUNTIME_HOURS)) + 
      # facet_wrap(~N_CELLS) + 
      geom_point() + 
      geom_smooth(method = "lm") + 
      scale_x_continuous(labels = scales::percent_format()) + 
      labs(x = "% Dynamic Genes", 
           y = "Runtime (Hours)", 
           title = "tradeSeq Computational Cost") + 
      theme_classic(base_size = 14) 
p6
```

### Modeling Compute Time 

```{r}
single_subj_mod_data <- metric_table %>% 
                        filter(DATASET_TYPE == "Single subject") %>% 
                        mutate(METHOD = case_when(grepl("scLANE_", DATASET_NAME) ~ "scLANE", TRUE ~ "tradeSeq")) %>% 
                        select(DATASET_NAME, 
                               METHOD, 
                               RUNTIME_HOURS, 
                               N_CELLS, 
                               N_GENES,
                               PERCENT_DEG) %>% 
                        mutate(across(c(N_CELLS, N_GENES, PERCENT_DEG), function(x) scale(x, scale = FALSE)))
m1 <- glm(RUNTIME_HOURS ~ METHOD + N_CELLS + N_GENES + PERCENT_DEG, 
          family = gaussian(), 
          data = single_subj_mod_data)
broom::tidy(m1) %>% 
  mutate(across(where(is.numeric), round, digits = 4))
```

## Memory Usage

### By $N_{cells}$

#### `scLANE`

#### `tradeSeq`

### By $N_{genes}$

#### `scLANE`

#### `tradeSeq`

### By $P_{DE}$

#### `scLANE`

```{r}
metric_table %>% 
  filter(grepl("scLANE_", DATASET_NAME), 
         DATASET_TYPE == "Single subject") %>% 
  ggplot(aes(x = PERCENT_DEG, y = MEM_USED)) + 
  geom_point() + 
  geom_smooth() + 
  scale_x_continuous(labels = scales::percent_format()) + 
  labs(x = "% Dynamic Genes", 
       y = "Memory Used (Mb)") + 
  theme_classic(base_size = 14) 
```

#### `tradeSeq`

## AUC-ROC

### `scLANE`

```{r, fig.width=5}
p <- metric_table %>% 
     filter(stringr::str_detect(DATASET_NAME, "scLANE_")) %>% 
     pull(ROC_CURVE) %>% 
     purrr::reduce(rbind) %>% 
     mutate(P_DEG = paste0(as.numeric(substr(stringr::str_extract(dataset, "DEG_[0-9][0-9]"), 5, 6)), "%"), 
            N_CELLS = stringr::str_replace(stringr::str_extract(dataset, "CELLS_.*"), "CELLS_", ""), 
            P_DEG = factor(P_DEG, levels = c("1%", "5%", "10%", "20%")), 
            N_CELLS = factor(N_CELLS, levels = as.character(sort(as.numeric(unique(N_CELLS)))))) %>% 
     ggplot(aes(x = 1 - specificity, y = sensitivity, group = dataset, color = N_CELLS)) + 
     facet_wrap(~P_DEG) + 
     geom_line(size = 1, alpha = 0.8) + 
     geom_abline(slope = 1, intercept = 0, color = "black", linetype = "dashed", size = 1) + 
     scale_x_continuous(labels = scales::percent_format(accuracy = 1)) + 
     scale_y_continuous(labels = scales::percent_format(accuracy = 1)) + 
     labs(x = "1 - Specificity", 
          y = "Sensitivity", 
          title = "ROC-AUC", 
          color = "Number of Cells", 
          subtitle = "scLANE on Single-Subject Simulated Data") + 
     theme_classic(base_size = 15) + 
     theme(plot.title = element_text(hjust = 0.5), 
           plot.subtitle = element_text(hjust = 0.5, face = "italic", size = 13), 
           plot.title.position = "panel")
p
save_plot(p.obj = p, 
          p.name = "Single_Subject_ROCAUC_Curves_scLANE.pdf", 
          data.type = "single")
```

### `tradeSeq`

```{r, fig.width=5}
p2 <- metric_table %>% 
     filter(stringr::str_detect(DATASET_NAME, "tradeSeq_")) %>% 
     pull(ROC_CURVE) %>% 
     purrr::reduce(rbind) %>% 
     mutate(P_DEG = paste0(as.numeric(substr(stringr::str_extract(dataset, "DEG_[0-9][0-9]"), 5, 6)), "%"), 
            N_CELLS = stringr::str_replace(stringr::str_extract(dataset, "CELLS_.*"), "CELLS_", ""), 
            P_DEG = factor(P_DEG, levels = c("1%", "5%", "10%", "20%")), 
            N_CELLS = factor(N_CELLS, levels = as.character(sort(as.numeric(unique(N_CELLS)))))) %>% 
     ggplot(aes(x = 1 - specificity, y = sensitivity, group = dataset, color = N_CELLS)) + 
     facet_wrap(~P_DEG) + 
     geom_line(size = 1, alpha = 0.8) + 
     geom_abline(slope = 1, intercept = 0, color = "black", linetype = "dashed", size = 1) + 
     scale_x_continuous(labels = scales::percent_format(accuracy = 1)) + 
     scale_y_continuous(labels = scales::percent_format(accuracy = 1)) + 
     labs(x = "1 - Specificity", 
          y = "Sensitivity", 
          title = "ROC-AUC", 
          color = "Number of Cells", 
          subtitle = "tradeSeq on Single-Subject Simulated Data") + 
     theme_classic(base_size = 15) + 
     theme(plot.title = element_text(hjust = 0.5), 
           plot.subtitle = element_text(hjust = 0.5, face = "italic", size = 13), 
           plot.title.position = "panel")
p2
save_plot(p.obj = p, 
          p.name = "Single_Subject_ROCAUC_Curves_scLANE.pdf", 
          data.type = "single")
```

## Distribution of ROC-AUC 

### `scLANE`

```{r}
metric_table %>% 
  filter(DATASET_TYPE == "Single subject") %>% 
  mutate(METHOD = case_when(grepl("scLANE_", DATASET_NAME) ~ "scLANE", TRUE ~ "tradeSeq")) %>% 
  select(METHOD, N_CELLS, N_GENES, ROC_AUC) %>% 
  ggplot(aes(x = METHOD, y = ROC_AUC, fill = METHOD)) + 
  geom_violin(draw_quantiles = 0.5, size = 1) + 
  scale_y_continuous(labels = scales::percent_format()) + 
  labs(x = "Method", y = "ROC-AUC", color = "Method") + 
  theme_classic(base_size = 14)
```

### `tradeSeq`

```{r}

```

## Distributions of P-values

### `scLANE`

```{r}
purrr::map2(scLANE_single_subj_list, names(scLANE_single_subj_list), function(x, y) {
  x$testDynamic_results_tidy[[1]] %>% 
    select(Gene, Test_Stat, P_Val, P_Val_Adj, Gene_Dynamic_Overall, geneStatus) %>% 
    mutate(Dataset = y, .before = 1)
}) %>% 
  purrr::reduce(rbind) -> scLANE_single_subj_pvals
scLANE_single_subj_pvals %>% 
  mutate(P_DEG = stringr::str_match(Dataset, "_DEG_[0-9]*") %>% stringr::str_remove("_DEG_")) %>% 
  mutate(across(contains("P_Val"), function(x) tidyr::replace_na(x, 1))) %>% 
  ggplot(aes(x = P_Val, fill = geneStatus)) + 
  facet_wrap(~P_DEG) + 
  geom_histogram(position = "dodge") + 
  theme_classic(base_size = 14)
```

### `tradeSeq`

```{r}
purrr::map2(tradeSeq_single_subj_list, names(tradeSeq_single_subj_list), function(x, y) {
  x$tradeSeq_results_tidy[[1]] %>% 
    select(gene, waldStat, pvalue, pvalue_adj, gene_dynamic_overall, geneStatus) %>% 
    mutate(Dataset = y, .before = 1)
}) %>% 
  purrr::reduce(rbind) -> tradeSeq_single_subj_pvals
tradeSeq_single_subj_pvals %>% 
  mutate(across(contains("pval"), function(x) tidyr::replace_na(x, 1))) %>% 
  ggplot(aes(x = pvalue_adj, fill = geneStatus)) + 
  geom_histogram(position = "dodge") + 
  theme_classic(base_size = 14)
```


# Multiple Subject Plots

```{r}
if (!dir.exists("./results/plots/MultiSubject")) {
  dir.create("./results/plots/MultiSubject")
}
```

## Compute Time

### By $N_{cells}$

#### `scLANE`

#### `tradeSeq`

### By $N_{genes}$

#### `scLANE`

#### `tradeSeq`

### By $P_{DE}$

#### `scLANE`

#### `tradeSeq`

## Memory Usage

### By $N_{cells}$

#### `scLANE`

#### `tradeSeq`

### By $N_{genes}$

#### `scLANE`

#### `tradeSeq`

### By $P_{DE}$

#### `scLANE`

#### `tradeSeq`

## AUC-ROC

### `scLANE`

### `tradeSeq`
